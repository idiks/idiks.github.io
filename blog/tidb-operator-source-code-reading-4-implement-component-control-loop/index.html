<!doctype html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<script>
window.ga =
    window.ga ||
    function() {
        ;(ga.q = ga.q || []).push(arguments)
    }
ga.l = +new Date()
ga('create', 'UA-99991864-4', 'auto')
ga('send', 'pageview')
</script>
<script async src="https://static.idiks.com/js/ga-analytics.js"></script>



<link rel="stylesheet" href="https://static.idiks.com/style/github-markdown.css">


<link rel="stylesheet" href="/css/doc.css">

    
    <title>TiDB Operator Source Code Reading (IV): Implementing a Component Control Loop |&nbsp;TiDB</title><link rel="icon" href="/images/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<meta name="description" content="This post explains how TiDB Operator implements a component control loop by taking PD as an example. You&#39;ll learn PD and other component&#39;s lifecycle management.">
<meta name="robots" content="noodp">
<meta name="keywords" content="TiDB, MySQL, HTAP, Open Source, Cloud-Native, NewSQL, Aurora Alternative">
<meta property="og:locale" content="en_US">
<meta property="og:type" content="website">
<meta property="og:title" content="TiDB Operator Source Code Reading (IV): Implementing a Component Control Loop | TiDB">
<meta property="og:description" content="This post explains how TiDB Operator implements a component control loop by taking PD as an example. You&#39;ll learn PD and other component&#39;s lifecycle management.">
<meta property="og:url" content="https://idiks.com/blog/tidb-operator-source-code-reading-4-implement-component-control-loop/">
<meta property="og:site_name" content="MySQL at Scale. No more manual sharding">
<meta property="og:image" content="/images/blog/tidb-operator-source-code-reading-4.jpg">
<meta property="og:image:secure_url" content="/images/blog/tidb-operator-source-code-reading-4.jpg"><meta name="twitter:card" content="summary_large_image">
<meta name="og:image:width" content="1200">
<meta name="og:image:height" content="600"><meta name="twitter:description" content="This post explains how TiDB Operator implements a component control loop by taking PD as an example. You&#39;ll learn PD and other component&#39;s lifecycle management.">
<meta name="twitter:title" content="TiDB Operator Source Code Reading (IV): Implementing a Component Control Loop | TiDB">
<meta name="twitter:site" content="@pingcap">
<meta name="twitter:image" content="https://static.idiks.com/images/blog/tidb-operator-source-code-reading-4.jpg"><meta name="twitter:creator" content="@pingcap">





<script type="application/ld+json">
{
    "@context": "http:\/\/schema.org",
    "@type": "WebSite",
    "url": "https:\/\/pingcap.com\/",
    "name": "PingCAP",
    "potentialAction": {
        "@type": "SearchAction",
        "target": "https:\/\/pingcap.com\/?s={search_term_string}",
        "query-input": "required name=search_term_string"
    }
}
</script>


<script>
    (function(){
        var bp = document.createElement('script');
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>


<script type="text/javascript" async src="https://accounts.pingcap.com/static/pingcap_sso/js/track.beta.js"></script>
    
<link rel="preload" href="https://static.idiks.com/fonts/lato/lato-regular-webfont.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://static.idiks.com/fonts/lato/lato-regular-webfont.woff" as="font" type="font/woff" crossorigin="anonymous">
<link rel="preload" href="https://static.idiks.com/fonts/lato/lato-regular-webfont.ttf" as="font" type="font/ttf" crossorigin="anonymous">
<link rel="preload" href="https://static.idiks.com/fonts/titilliumweb/titilliumweb-regular-webfont.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://static.idiks.com/fonts/titilliumweb/titilliumweb-regular-webfont.woff" as="font" type="font/woff" crossorigin="anonymous">
<link rel="preload" href="https://static.idiks.com/fonts/titilliumweb/titilliumweb-regular-webfont.ttf" as="font" type="font/ttf" crossorigin="anonymous">

<link rel="preload" href="https://static.idiks.com/js/jquery.min.js" as="script">


<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="https://static.idiks.com/style/docsearch.min.css">
<script type="text/javascript">
var trackOutboundLink = function(url) {
  var redirectTriggered = false
  ga('send', 'event', 'outbound', 'click', url, {
    hitCallback: function() {
      redirectTriggered = true
      document.location = url
    }
  })
  setTimeout(function() {
    if (!redirectTriggered) {
      document.location = url
    }
  }, 1500)
}

var trackViews = function(btn_type, event_category) {
  var event_label = btn_type
  var eventCategory = event_category
  ga('send', 'event', {
    'eventCategory': eventCategory,
    'eventAction': 'click',
    'eventLabel': event_label,
    'transport': 'beacon'
  });
}
</script>
<script>if (location.pathname === '/') {
        if (location.hostname === 'idiks.github.io') {
            location.href = '/en/'
        }
    }</script></head>       <body data-lang="en" ><div id="page-content">

<header role="navigation" class="fixed-top">
    <div class="container">
        <a class="nav-brand" href="/en"><img src="/images/pingcap-logo.png" alt="PingCAP"></a>
        <div class="nav-wrapper">
            <div class="navigation">
                <ul>
                <li ><a class="a-en" href="https://idiks.com">Cloud</a></li>
                <li ><a class="a-en" class="tidb-academy"
                    href="/tidb-academy">iDIKS Academy</a></li>
                <li class="docs-type-selector " id="docsTypeSelector">
                    <a class="header-doc-nav" href="#">Docs</a>
                    <div class="header-dropdown-menu" id="docsTypeSelectorItem">
                        <a class="header-dropdown-item" href="/docs/stable/">TiDB</a>
                        <a class="header-dropdown-item" href="/docs/tidb-in-kubernetes/stable/">TiDB in Kubernetes</a>
                        <a class="header-dropdown-item" href="/docs/tidb-data-migration/stable/">TiDB Data Migration (DM)</a>
                    </div>
                </li>
                
                <li ><a class="a-en" href="/success-stories">Success
                    Stories</a></li>
                <li class="sel" ><a class="a-en" href="/blog">Blog</a></li>
                <li ><a class="link-download link-download-en" href="/download">Free Download</a></li>
                </ul>
            </div>
            <div class="global-search">
                
                
                
                <div class="search-wrapper">
    <span class="icon-search"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#fff" viewBox="0 0 67.125 67.125"><path d="M23.902 0C11.01 0 .523 10.488.523 23.38c0 12.891 10.487 23.379 23.379 23.379a23.258 23.258 0 0 0 14.471-5.037l24.816 24.817c.391.391.902.586 1.414.586s1.023-.195 1.414-.586a2 2 0 0 0 0-2.828L41.293 38.985c3.721-4.142 5.989-9.613 5.989-15.605C47.282 10.488 36.794 0 23.902 0zM4.523 23.38C4.523 12.694 13.216 4 23.902 4c10.687 0 19.38 8.694 19.38 19.38 0 5.396-2.221 10.279-5.791 13.795a1.959 1.959 0 0 0-.488.349 2.003 2.003 0 0 0-.271.343C33.31 40.9 28.825 42.76 23.903 42.76c-10.686-.001-19.38-8.695-19.38-19.38z"/><path d="M24.075 8.591c-8.25 0-14.962 6.712-14.962 14.962a2 2 0 0 0 4 0c0-6.044 4.918-10.962 10.962-10.962a2 2 0 0 0 0-4z"/></svg></span>
    <input data-lang="en" data-type="" type="search" id="search-input" name="q"
        placeholder="Search TiDB Docs">
</div>

<script>
    const inputNode = document.getElementById("search-input")

    inputNode.addEventListener('keyup', ({key}) => {
        if (key === "Enter") {
            if ($('#search-input').data('lang') == 'cn') {
                lang = 'zh'
            }

            const query = $('#search-input').val()
            if (query) {
                url = "https://idiks.com/docs" + (lang == 'zh' ? 'zh/' : '') + "search/?lang=" + lang + "&type=tidb&version=v4.0&q=" + query
                window.location.href = url
            }
        }
    })
</script>

            </div>
        </div>
        <div class="nav-btn nav-slider">
            <i class="material-icons"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 459 459"><path d="M0 382.5h459v-51H0v51zM0 255h459v-51H0v51zM0 76.5v51h459v-51H0z" fill="#FFF"/></svg></i>
        </div>
    </div>
</header>



<nav class="mobile-sidebar">
    <div class="nav-header">
        <div class="logo-wrap">
        <a class="nav-brand" href="/en"><img src="/images/pingcap-logo.png" alt="PingCAP"></a>
        </div>
    </div>
    <ul class="ul-base">
        <li ><a href="https://idiks.com/">Cloud</a></li>
        <li ><a class="tidb-academy" href="/tidb-academy">TiDB Academy</a></li>
        <li class="docs-type-selector " id="docsTypeSelector">
            <p class="header-doc-nav">Docs</p>
            <div class="header-dropdown-menu" id="docsTypeSelectorItem">
                <a class="header-dropdown-item" href="/docs/stable/">TiDB</a>
                <a class="header-dropdown-item" href="/docs/tidb-in-kubernetes/stable/">TiDB in Kubernetes</a>
                <a class="header-dropdown-item" href="/docs/tidb-data-migration/stable/">TiDB Data Migration (DM)</a>
            </div>
        </li>
        <li ><a href="/success-stories">Success Stories</a></li>
        <li class="sel"><a href="/blog">Blog</a></li>
        <li><a class="link-download" href="/download">Free Download</a></li>
    </ul>
    <div class="nav-footer">
        <div class="contact-list-wrap">
        <div class="flex-list">
            <h4 class="list-title"><strong>Contact</strong></h4>
            <ul class="social ul-base">
            <li><a href="https://twitter.com/PingCAP" class="twitter" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" width="18" height="18"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"/></svg></a></li>
            <li><a href="https://www.linkedin.com/company/pingcap/" class="linkedin" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 438.536 438.535"><path d="M5.424 145.895H99.64v282.932H5.424zM408.842 171.739c-19.791-21.604-45.967-32.408-78.512-32.408-11.991 0-22.891 1.475-32.695 4.427-9.801 2.95-18.079 7.089-24.838 12.419-6.755 5.33-12.135 10.278-16.129 14.844-3.798 4.337-7.512 9.389-11.136 15.104v-40.232h-93.935l.288 13.706c.193 9.139.288 37.307.288 84.508 0 47.205-.19 108.777-.572 184.722h93.931V270.942c0-9.705 1.041-17.412 3.139-23.127 4-9.712 10.037-17.843 18.131-24.407 8.093-6.572 18.13-9.855 30.125-9.855 16.364 0 28.407 5.662 36.117 16.987 7.707 11.324 11.561 26.98 11.561 46.966V428.82h93.931V266.664c-.007-41.688-9.897-73.328-29.694-94.925zM53.103 9.708c-15.796 0-28.595 4.619-38.4 13.848C4.899 32.787 0 44.441 0 58.529 0 72.42 4.758 84.034 14.275 93.358c9.514 9.325 22.078 13.99 37.685 13.99h.571c15.99 0 28.887-4.661 38.688-13.99 9.801-9.324 14.606-20.934 14.417-34.829-.19-14.087-5.047-25.742-14.561-34.973C81.562 14.323 68.9 9.708 53.103 9.708z"/></svg></a></li>
            <li><a href="https://www.reddit.com/r/TiDB/" class="reddit" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 279.748 279.748" width="18" height="18"><path d="M279.748 133.142c0-19.299-15.701-35-35-35-10.768 0-20.674 4.812-27.279 13.064-18.532-8.431-39.663-13.626-62.015-15.271l19.206-60.692 42.895 9.294c3.285 12.782 14.901 22.258 28.693 22.258 16.336 0 29.627-13.29 29.627-29.626 0-16.336-13.291-29.627-29.627-29.627-11.801 0-21.999 6.941-26.759 16.95l-49.497-10.725a10.002 10.002 0 0 0-11.651 6.756L134.636 95.43c-26.164.638-50.988 6.053-72.356 15.775-6.606-8.251-16.512-13.063-27.28-13.063-19.299 0-35 15.701-35 35 0 9.373 3.683 18.173 10.222 24.709-3.9 8.37-5.875 17.076-5.875 25.936 0 24.048 14.396 46.492 40.538 63.199 25.447 16.264 59.183 25.221 94.989 25.221 35.808 0 69.542-8.957 94.989-25.221 26.142-16.707 40.538-39.151 40.538-63.199 0-8.859-1.975-17.565-5.875-25.936 6.539-6.537 10.222-15.336 10.222-24.709zM15.369 145.139c-2.212-3.59-3.369-7.688-3.369-11.997 0-12.682 10.317-23 23-23 5.444 0 10.558 1.851 14.649 5.258-14.622 8.302-26.132 18.289-34.28 29.739zm52.671 20.266c0-13.785 11.215-25 25-25s25 11.215 25 25-11.215 25-25 25-25-11.215-25-25zm123.119 57.054c-9.745 10.637-29.396 17.244-51.285 17.244-21.888 0-41.539-6.607-51.284-17.244a9.937 9.937 0 0 1-2.617-7.192 9.933 9.933 0 0 1 3.235-6.937 9.974 9.974 0 0 1 6.754-2.627c2.797 0 5.484 1.183 7.373 3.244 5.803 6.333 20.827 10.756 36.539 10.756s30.737-4.423 36.539-10.756a10.022 10.022 0 0 1 7.374-3.244c2.508 0 4.906.933 6.755 2.627a9.928 9.928 0 0 1 3.234 6.937 9.933 9.933 0 0 1-2.617 7.192zm-4.451-32.054c-13.785 0-25-11.215-25-25s11.215-25 25-25 25 11.215 25 25-11.215 25-25 25zm77.671-45.266c-8.147-11.45-19.657-21.436-34.28-29.739 4.092-3.408 9.205-5.258 14.649-5.258 12.683 0 23 10.318 23 23 0 4.309-1.157 8.407-3.369 11.997z"/></svg></a></li>
            <li><a href="https://groups.google.com/forum/#!forum/tidb-user" class="google-plus" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 491.858 491.858" width="18" height="18"><path d="M377.472 224.957H201.319v58.718H308.79c-16.032 51.048-63.714 88.077-120.055 88.077-69.492 0-125.823-56.335-125.823-125.824 0-69.492 56.333-125.823 125.823-125.823 34.994 0 66.645 14.289 89.452 37.346l42.622-46.328c-34.04-33.355-80.65-53.929-132.074-53.929C84.5 57.193 0 141.693 0 245.928s84.5 188.737 188.736 188.737c91.307 0 171.248-64.844 188.737-150.989v-58.718l-.001-.001zM491.858 224.857h-36.031v-36.031h-30.886v36.031H388.91v30.883h36.031v36.032h30.886V255.74h36.031z"/></svg></a></li>
            <li><a href="https://stackoverflow.com/questions/tagged/tidb" class="stack-overflow" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 547.597 547.597"><path d="M140.81 475.111h.024l189.91-.269c8.434-.013 15.3-6.886 15.3-15.318v-21.298c0-8.428-6.854-15.288-15.3-15.288l-189.91.264c-8.433.012-15.3 6.885-15.3 15.318v21.31c.001 8.427 6.855 15.281 15.276 15.281z"/><path d="M58.667 517.854c.073 29.26.073 29.449 3.072 29.449h.055l10.612.294h.086s85.814 0 171.629-.036c42.914-.019 85.821-.05 118-.092 16.09-.019 29.505-.043 38.887-.074 17.803-.055 17.803-.055 17.803-3.072l.3-10.697V333.299c0-8.434-6.866-15.3-15.3-15.3h-11.909c-8.434 0-15.3 6.866-15.3 15.3V496.22c0 5.062-4.119 9.18-9.181 9.18H110.51c-5.061 0-9.18-4.118-9.18-9.18V333.299c0-8.434-6.867-15.3-15.3-15.3H73.82c-8.433 0-15.3 6.86-15.3 15.3 0 23.342.012 76.084.055 122.981.019 23.447.05 45.442.092 61.574z"/><path d="M142.322 397.399l189.402 17.467c.478.043.948.062 1.413.062 7.956 0 14.468-5.985 15.159-13.917l1.83-21.096c.729-8.396-5.508-15.851-13.898-16.628l-189.102-17.461c-8.593-.795-15.869 5.441-16.653 13.825l-1.97 21.108a15.172 15.172 0 0 0 3.452 11.181 15.19 15.19 0 0 0 10.367 5.459zM437.636 208.849a15.253 15.253 0 0 0 17.694 12.443l21.065-3.678c8.311-1.451 13.898-9.395 12.454-17.706l-32.504-187.23c-1.42-8.207-9.21-13.917-17.692-12.448l-21.065 3.678c-8.311 1.451-13.898 9.395-12.454 17.705l32.502 187.236zM190.333 194.375l163.6 96.708a15.28 15.28 0 0 0 7.778 2.136c5.393 0 10.447-2.876 13.183-7.509l10.876-18.36c2.08-3.519 2.674-7.631 1.658-11.591a15.18 15.18 0 0 0-7.032-9.358l-163.6-96.714c-7.014-4.149-16.836-1.597-20.967 5.374l-10.869 18.36a15.2 15.2 0 0 0-1.658 11.591 15.21 15.21 0 0 0 7.031 9.363zM387.525 240.501a15.276 15.276 0 0 0 12.626 6.659c3.091 0 6.077-.924 8.635-2.681l17.405-11.934c6.953-4.768 8.752-14.314 4.015-21.292L323.29 54.104c-4.584-6.732-14.498-8.623-21.236-3.984l-17.737 12.21c-6.945 4.779-8.727 14.327-3.971 21.291l107.179 156.88zM154.482 302.319l183.465 49.156c1.298.349 2.632.526 3.966.526 6.903 0 12.98-4.67 14.762-11.347l5.508-20.624c2.179-8.152-2.681-16.555-10.826-18.74l-183.465-49.162c-8.017-2.148-16.604 2.852-18.728 10.826l-5.508 20.63c-2.179 8.142 2.68 16.551 10.826 18.735z"/></svg></a></li>
            </ul>
        </div>
        <div class="subscribe">
            <a href="https://share.hsforms.com/1e2W03wLJQQKPd1d9rCbj_Q2npzm"><button class="btn btn-subscribe f-tc" style="margin-left: 0.75rem;">Subscribe to Blog</button></a>
        </div>
        </div>
        <div class="container">
        <a href="/blog-cn" class="btn-lang" id="lang">中文</a>
        </div>
    </div>
</nav>

<div class="blog">
        <div class="blogArticle__container">
            
            <div class="archive"><div class="article-nav">
                            <a href="/blog/#Engineering">BLOG HOME</a> <span> > </span>Engineering</div><div class="content markdown-body">
                    <h1 class="title">TiDB Operator Source Code Reading (IV): Implementing a Component Control Loop</h1>
                    <ul class="blog-post-meta">
                        <li class="meta-item">
                            <img src="/images/svgs/icon-date.svg" alt="Date icon">Thu, Oct 28, 2021</li>
                        <li class="meta-item">
                            <img src="/images/svgs/icon-writer.svg" alt="Pen icon">Yiwen Chen</li>
                    </ul>
                    <div class="blog-text"><p><strong>Author:</strong> <a href="https://github.com/handlerww">Yiwen Chen</a> (Committer of TiDB Operator, Software Engineer at PingCAP)</p>
<p><strong>Transcreator:</strong> Ran Huang; <strong>Editor:</strong> Tom Dewan</p>
<p><img src="media/tidb-operator-source-code-reading-4.jpg" alt="TiDB Operator Source Code Reading (IV): Implementing a Component Control Loop"></p>
<blockquote>
<p><em>Previous articles in this series:</em></p>
<ul>
<li><em><a href="https://pingcap.com/blog/tidb-operator-source-code-reading-1-overview">TiDB Operator Source Code Reading (I): Overview</a></em></li>
<li><em><a href="https://pingcap.com/blog/tidb-operator-source-code-reading-2-operator-pattern">TiDB Operator Source Code Reading (II): Operator Pattern</a></em></li>
<li><em><a href="https://pingcap.com/blog/tidb-operator-source-code-reading-3-component-control-loop">TiDB Operator Source Code Reading (III): The Component Control Loop</a></em></li>
</ul>
</blockquote>
<p>In our <a href="https://pingcap.com/blog/tidb-operator-source-code-reading-3-component-control-loop">last article</a>, we introduced how TiDB Operator orchestrates control loop events to manage the lifecycles of TiDB components. The <code>TidbCluster</code> controller manages TiDB components&rsquo; lifecycles, and the member manager of each TiDB component encapsulates that component's specific management logic.</p>
<p>In this post, I'll explain in detail <strong>how we implement a component control loop by taking PD as an example</strong>. You'll learn about the PD member manager and its lifecycle management operations. I'll also compare other components with PD and show their differences.</p>
<h2 id="the-pd-control-loop">The PD control loop</h2>
<p><a href="https://docs.pingcap.com/tidb/stable/tidb-scheduling">Placement Driver</a> (PD) manages a TiDB cluster and schedules Regions in the cluster. The PD member manager maintains the PD lifecycle management logic. Most of its code resides in <code>pkg/manager/member/pd_member_manager.go</code>, and other code related to scaling, upgrade, and failover is located in <code>pd_scaler.go</code>, <code>pd_upgrader.go</code>, and <code>pd_failover.go</code> respectively.</p>
<p>As is illustrated in <a href="https://pingcap.com/blog/tidb-operator-source-code-reading-3-component-control-loop#call-the-component-control-loop">Part III</a>, it takes the following tasks to manage a component's lifecycle:</p>
<ul>
<li>Sync Service</li>
<li>Start syncing StatefulSet</li>
<li>Sync status</li>
<li>Sync ConfigMap</li>
<li>Rolling update</li>
<li>Scaling in and scaling out</li>
<li>Failover</li>
<li>Finish syncing StatefulSet</li>
</ul>
<p>Syncing StatefulSet is the major logic. Other tasks, like syncing status and syncing ConfigMap, are defined as sub-functions and called by the PD member manager when it syncs StatefulSet.</p>
<h3 id="sync-statefulset">Sync StatefulSet</h3>
<p>To sync StatefulSet, the PD member manager:</p>
<ol>
<li>
<p>Obtains the current PD StatefulSet using <code>StatefulSetLister</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">oldPDSetTmp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">deps</span>.<span style="color:#a6e22e">StatefulSetLister</span>.<span style="color:#a6e22e">StatefulSets</span>(<span style="color:#a6e22e">ns</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">PDMemberName</span>(<span style="color:#a6e22e">tcName</span>))
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsNotFound</span>(<span style="color:#a6e22e">err</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;syncPDStatefulSetForTidbCluster: fail to get sts %s for cluster %s/%s, error: %s&#34;</span>, <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">PDMemberName</span>(<span style="color:#a6e22e">tcName</span>), <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">tcName</span>, <span style="color:#a6e22e">err</span>)
}
<span style="color:#a6e22e">setNotExist</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsNotFound</span>(<span style="color:#a6e22e">err</span>)

<span style="color:#a6e22e">oldPDSet</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">oldPDSetTmp</span>.<span style="color:#a6e22e">DeepCopy</span>()
</code></pre></div></li>
<li>
<p>Gets the latest status using <code>m.syncTidbClusterStatus(tc, oldPDSet)</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">syncTidbClusterStatus</span>(<span style="color:#a6e22e">tc</span>, <span style="color:#a6e22e">oldPDSet</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to sync TidbCluster: [%s/%s]&#39;s status, error: %v&#34;</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">tcName</span>, <span style="color:#a6e22e">err</span>)
}
</code></pre></div></li>
<li>
<p>Checks whether the TiDB cluster pauses the synchronization. If so, terminate the following reconciliation.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Paused</span> {
    <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;tidb cluster %s/%s is paused, skip syncing for pd statefulset&#34;</span>, <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">GetNamespace</span>(), <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">GetName</span>())
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div></li>
<li>
<p>Syncs ConfigMap according to the latest <code>tc.Spec</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">cm</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">syncPDConfigMap</span>(<span style="color:#a6e22e">tc</span>, <span style="color:#a6e22e">oldPDSet</span>)
</code></pre></div></li>
<li>
<p>Generates the latest StatefulSet template according to the latest <code>tc.Spec</code>, <code>tc.Status</code>, and ConfigMap obtained in the last step.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">newPDSet</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getNewPDSetForTidbCluster</span>(<span style="color:#a6e22e">tc</span>, <span style="color:#a6e22e">cm</span>)
</code></pre></div></li>
<li>
<p>If the new PD StatefulSet hasn't been created yet, first create the StatefulSet.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">setNotExist</span> {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">SetStatefulSetLastAppliedConfigAnnotation</span>(<span style="color:#a6e22e">newPDSet</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">deps</span>.<span style="color:#a6e22e">StatefulSetControl</span>.<span style="color:#a6e22e">CreateStatefulSet</span>(<span style="color:#a6e22e">tc</span>, <span style="color:#a6e22e">newPDSet</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">PD</span>.<span style="color:#a6e22e">StatefulSet</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">apps</span>.<span style="color:#a6e22e">StatefulSetStatus</span>{}
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">RequeueErrorf</span>(<span style="color:#e6db74">&#34;TidbCluster: [%s/%s], waiting for PD cluster running&#34;</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">tcName</span>)
}
</code></pre></div></li>
<li>
<p>If a user configures a forced upgrade using <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/annotations/">annotations</a>, this step configures the StatefulSet to perform a rolling upgrade directly. This is to avoid an upgrade failure if the reconciliation loop is blocked.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">PD</span>.<span style="color:#a6e22e">Synced</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">NeedForceUpgrade</span>(<span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Annotations</span>) {
    <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">PD</span>.<span style="color:#a6e22e">Phase</span> = <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">UpgradePhase</span>
    <span style="color:#a6e22e">setUpgradePartition</span>(<span style="color:#a6e22e">newPDSet</span>, <span style="color:#ae81ff">0</span>)
    <span style="color:#a6e22e">errSTS</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">UpdateStatefulSet</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">deps</span>.<span style="color:#a6e22e">StatefulSetControl</span>, <span style="color:#a6e22e">tc</span>, <span style="color:#a6e22e">newPDSet</span>, <span style="color:#a6e22e">oldPDSet</span>)
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">RequeueErrorf</span>(<span style="color:#e6db74">&#34;tidbcluster: [%s/%s]&#39;s pd needs force upgrade, %v&#34;</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">tcName</span>, <span style="color:#a6e22e">errSTS</span>)
}
</code></pre></div></li>
<li>
<p>Calls the scaling logic implemented in <code>pd_scaler.go</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">scaler</span>.<span style="color:#a6e22e">Scale</span>(<span style="color:#a6e22e">tc</span>, <span style="color:#a6e22e">oldPDSet</span>, <span style="color:#a6e22e">newPDSet</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
}
</code></pre></div></li>
<li>
<p>Calls the failover logic implemented in <code>pd_failover.go</code>. The function first checks if the cluster needs to recover, then checks if all Pods are started and all members are healthy, and finally determines whether it needs to begin failover.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">deps</span>.<span style="color:#a6e22e">CLIConfig</span>.<span style="color:#a6e22e">AutoFailover</span> {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">shouldRecover</span>(<span style="color:#a6e22e">tc</span>) {
        <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">failover</span>.<span style="color:#a6e22e">Recover</span>(<span style="color:#a6e22e">tc</span>)
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">PDAllPodsStarted</span>() <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">PDAllMembersReady</span>() <span style="color:#f92672">||</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">PDAutoFailovering</span>() {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">failover</span>.<span style="color:#a6e22e">Failover</span>(<span style="color:#a6e22e">tc</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
    }
}
</code></pre></div></li>
<li>
<p>Calls the upgrade logic implemented in <code>pd_upgrader.go</code>. When the newly generated PD StatefulSet is inconsistent with the existing one or when the two StatefulSets are consistent but <code>tc.Status.PD.Phase</code> is <code>upgrade</code>, the PD Member Manager enters <code>upgrader</code> to process the rolling upgrade logic.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">templateEqual</span>(<span style="color:#a6e22e">newPDSet</span>, <span style="color:#a6e22e">oldPDSet</span>) <span style="color:#f92672">||</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">PD</span>.<span style="color:#a6e22e">Phase</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">UpgradePhase</span> {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">upgrader</span>.<span style="color:#a6e22e">Upgrade</span>(<span style="color:#a6e22e">tc</span>, <span style="color:#a6e22e">oldPDSet</span>, <span style="color:#a6e22e">newPDSet</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }
}
</code></pre></div></li>
<li>
<p>The PD StatefulSet is synced, and the new StatefulSet is updated to the Kubernetes cluster.</p>
</li>
</ol>
<h3 id="sync-service">Sync Service</h3>
<p>PD uses ​​both <a href="https://kubernetes.io/docs/concepts/services-networking/service/">Services</a> and <a href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services">headless Services</a>, managed by <code>syncPDServiceForTidbCluster</code> and <code>syncPDHeadlessServiceForTidbCluster</code>.</p>
<p>The Service address is used in TiDB, TiKV, and TiFlash to configure the PD endpoint. For example, TiDB uses <code>--path=${CLUSTER_NAME}-pd:2379</code> as its PD service address in the startup parameter:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">ARGS=&#34;--store=tikv \
--advertise-address=${POD_NAME}.${HEADLESS_SERVICE_NAME}.${NAMESPACE}.svc \
--path=${CLUSTER_NAME}-pd:2379 \
</code></pre></div><p>The headless Service provides a unique identifier for each Pod. When PD starts up, the PD Pod registers its endpoint in PD members as <code>&quot;${POD_NAME}.${PEER_SERVICE_NAME}.${NAMESPACE}.svc&quot;</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">domain=&#34;${POD_NAME}.${PEER_SERVICE_NAME}.${NAMESPACE}.svc&#34;
ARGS=&#34;--data-dir=/var/lib/pd \
--name=${POD_NAME} \
--peer-urls=http://0.0.0.0:2380 \
--advertise-peer-urls=http://${domain}:2380 \
--client-urls=http://0.0.0.0:2379 \
--advertise-client-urls=http://${domain}:2379 \
--config=/etc/pd/pd.toml \
&#34;
</code></pre></div><h3 id="sync-configmap">Sync ConfigMap</h3>
<p>PD uses ConfigMap to manage the configurations and the start script. The <code>syncPDConfigMap</code> function calls <code>getPDConfigMap</code> to get the latest ConfigMap and apply it to the Kubernetes cluster. ConfigMap handles the following tasks:</p>
<ol>
<li>
<p>Get <code>PD.Config</code> for the follow-up sync. To remain compatible with earlier versions that use Helm, when the config object is empty, ConfigMap is not synced.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">config</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">PD</span>.<span style="color:#a6e22e">Config</span>
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">config</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div></li>
<li>
<p>Modify TLS-related configuration. Because TiDB 4.0 and earlier versions don't support TiDB Dashboard, PD member manager skips configuring Dashboard certificates for PD in earlier versions.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// override CA if tls enabled
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">IsTLSClusterEnabled</span>() {
    <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;security.cacert-path&#34;</span>, <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">pdClusterCertPath</span>, <span style="color:#a6e22e">tlsSecretRootCAKey</span>))
    <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;security.cert-path&#34;</span>, <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">pdClusterCertPath</span>, <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">TLSCertKey</span>))
    <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;security.key-path&#34;</span>, <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">pdClusterCertPath</span>, <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">TLSPrivateKeyKey</span>))
}
<span style="color:#75715e">// Versions below v4.0 do not support Dashboard
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">TiDB</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">TiDB</span>.<span style="color:#a6e22e">IsTLSClientEnabled</span>() <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">SkipTLSWhenConnectTiDB</span>() <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">clusterVersionGE4</span> {
    <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;dashboard.tidb-cacert-path&#34;</span>, <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">tidbClientCertPath</span>, <span style="color:#a6e22e">tlsSecretRootCAKey</span>))
    <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;dashboard.tidb-cert-path&#34;</span>, <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">tidbClientCertPath</span>, <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">TLSCertKey</span>))
    <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;dashboard.tidb-key-path&#34;</span>, <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">tidbClientCertPath</span>, <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">TLSPrivateKeyKey</span>))
}
</code></pre></div></li>
<li>
<p>Transform the configuration to TOML format so that PD can read it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">confText</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">MarshalTOML</span>()
</code></pre></div></li>
<li>
<p>Generate the PD start script using <code>RenderPDStartScript</code>. The script template is stored in the <code>pdStartScriptTpl</code> variable in <code>pkg/manager/member/template.go</code>. The PD start script is a Bash script. <code>RenderPDStartScript</code> inserts some variables and annotations configured by the <code>TidbCluster</code> object into the start script. These variables and annotations are used for PD startup and debugging.</p>
</li>
<li>
<p>Assemble the PD configurations and the start script as the Kubernetes ConfigMap object, and return the ConfigMap to the <code>syncPDConfigMap</code> function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">cm</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">ConfigMap</span>{
    <span style="color:#a6e22e">ObjectMeta</span>: <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span>{
        <span style="color:#a6e22e">Name</span>:            <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">PDMemberName</span>(<span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Name</span>),
        <span style="color:#a6e22e">Namespace</span>:       <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Namespace</span>,
        <span style="color:#a6e22e">Labels</span>:          <span style="color:#a6e22e">pdLabel</span>,
        <span style="color:#a6e22e">OwnerReferences</span>: []<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">OwnerReference</span>{<span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">GetOwnerRef</span>(<span style="color:#a6e22e">tc</span>)},
    },
    <span style="color:#a6e22e">Data</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{
        <span style="color:#e6db74">&#34;config-file&#34;</span>:    string(<span style="color:#a6e22e">confText</span>),
        <span style="color:#e6db74">&#34;startup-script&#34;</span>: <span style="color:#a6e22e">startScript</span>,
    },
}
</code></pre></div></li>
</ol>
<h3 id="scaling">Scaling</h3>
<p>The scaling logic is implemented <code>in pkg/manager/member/pd_scaler.go</code>. The StatefulSet calls the <code>Scale</code> function to scale out or scale in the PD cluster.</p>
<p>Before scaling, TiDB Operator needs to perform some preliminary operations. For example, to scale in the PD cluster, TiDB Operator needs to transfer Leaders, take members offline, and add annotations to <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#introduction">PersistentVolumeClaims</a> (PVCs) for deferred deletion. To scale out the cluster, TiDB Operator needs to delete the previously retained PVCs.</p>
<p>After the preliminary operations are completed, TiDB Operator adjusts the number of StatefulSet replicas and begins the scaling process. The preliminary operations minimize the impact of the scaling operation.</p>
<p>The <code>Scale</code> function acts like a router. Based on the scaling direction, step, and length, it determines which scaling plan to use. If the <code>scaling</code> variable is a positive number, PD is scaled out; otherwise, PD is scaled in. In each scaling operation, PD is only scaled by one step. The specific plan is implemented by the <code>ScaleIn</code> and <code>ScaleOut</code> functions.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pdScaler</span>) <span style="color:#a6e22e">Scale</span>(<span style="color:#a6e22e">meta</span> <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">Object</span>, <span style="color:#a6e22e">oldSet</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">apps</span>.<span style="color:#a6e22e">StatefulSet</span>, <span style="color:#a6e22e">newSet</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">apps</span>.<span style="color:#a6e22e">StatefulSet</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#a6e22e">scaling</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">scaleOne</span>(<span style="color:#a6e22e">oldSet</span>, <span style="color:#a6e22e">newSet</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">scaling</span> &gt; <span style="color:#ae81ff">0</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ScaleOut</span>(<span style="color:#a6e22e">meta</span>, <span style="color:#a6e22e">oldSet</span>, <span style="color:#a6e22e">newSet</span>)
    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">scaling</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">lt</span>; <span style="color:#ae81ff">0</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ScaleIn</span>(<span style="color:#a6e22e">meta</span>, <span style="color:#a6e22e">oldSet</span>, <span style="color:#a6e22e">newSet</span>)
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">SyncAutoScalerAnn</span>(<span style="color:#a6e22e">meta</span>, <span style="color:#a6e22e">oldSet</span>)
}
</code></pre></div><h4 id="scaling-in">Scaling in</h4>
<p>Before TiDB Operator takes a PD member offline, it must <strong>transfer the Leader</strong>. Otherwise, when the Leader member is taken offline, the rest of the PD members are forced into a Leader election, which affects cluster performance. Therefore, TiDB Operator needs to transfer the Leader to the PD member with the smallest ID. This makes sure that the PD Leader is only transferred once.</p>
<p>To transfer the PD Leader, first get the PD client and the PD Leader:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">pdClient</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">GetPDClient</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">deps</span>.<span style="color:#a6e22e">PDControl</span>, <span style="color:#a6e22e">tc</span>)
<span style="color:#a6e22e">leader</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pdClient</span>.<span style="color:#a6e22e">GetPDLeader</span>()
</code></pre></div><p>When the Leader name equals the member name, TiDB Operator transfers the Leader. If there is only one member left, no other member is available for transfer, so TiDB Operator skips transferring the Leader.</p>
<p>After the Leader is transferred, the <code>ScaleIn</code> function calls PD's <code>DeleteMember</code> API and deletes the member from PD members. The PD member is then taken offline. Finally, the function calls <code>setReplicasAndDeleteSlots</code> to adjust the number of StatefulSet replicas, and the scaling-in process is completed.</p>
<h4 id="scaling-out">Scaling out</h4>
<p>Before TiDB Operator scales out the PD cluster, it needs to delete deferred PVCs by calling <code>deleteDeferDeletingPVC</code>. When TiDB Operator previously scaled in PD, these PVCs were retained for deferred deletion to achieve data reliability; now, TiDB Operator must delete them to avoid the cluster using old data. After these PVCs are deleted, TiDB Operator only has to adjust the number of StatefulSet replicas and scale out the PD cluster.</p>
<p>Whether you scale in or scale out the PD cluster, the operation is performed by configuring the number of StatefulSet replicas. Therefore, when TiDB Operator supports the <a href="https://docs.pingcap.com/tidb-in-kubernetes/stable/advanced-statefulset">advanced StatefulSet</a>, it must take into account the empty slots when counting the replicas.</p>
<div class="trackable-btns">
  <a href="/download" onclick="trackViews('TiDB Operator Source Code Reading (IV): Implementing a Component Control Loop', 'download-tidb-btn-middle')"><button>Download TiDB</button></a>
  <a href="https://share.hsforms.com/1e2W03wLJQQKPd1d9rCbj_Q2npzm" onclick="trackViews('TiDB Operator Source Code Reading (IV): Implementing a Component Control Loop', 'subscribe-blog-btn-middle')"><button>Subscribe to Blog</button></a>
</div>
<h3 id="rolling-upgrade">Rolling upgrade</h3>
<p>The upgrade logic is implemented in <code>pkg/manager/member/pd_upgrader.go</code>. The <code>UpdateStrategy</code> in the StatefulSet performs the rolling upgrade on PD. To mitigate the impact of upgrade on the PD cluster, <code>pd_upgrader.go</code> performs some preliminary operations when it updates <code>UpdateStrategy</code> in the StatefulSet. For details on how to control <code>UpdateStrategy</code>, refer to <a href="https://pingcap.com/blog/tidb-operator-source-code-reading-3-component-control-loop#rolling-update">our last article</a>.</p>
<p>Before upgrade, TiDB Operator completes the following status check:</p>
<ol>
<li>
<p>It checks whether there are other ongoing operations. In particular, it checks whether TiCDC and TiFlash is being upgraded and whether PD is being scaled out or scaled in.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">TiCDC</span>.<span style="color:#a6e22e">Phase</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">UpgradePhase</span> <span style="color:#f92672">||</span>
    <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">TiFlash</span>.<span style="color:#a6e22e">Phase</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">UpgradePhase</span> <span style="color:#f92672">||</span>
    <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">PDScaling</span>()
</code></pre></div></li>
<li>
<p>The PD member manager determines to enter <code>Upgrader</code> on two circumstances:</p>
<ul>
<li>
<p>When the newly generated PD StatefulSet is inconsistent with the existing one, the status check returns <code>nil</code>, and TiDB Operator updates the StatefulSet. There is no need to perform the following checks in steps 3 and 4.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">templateEqual</span>(<span style="color:#a6e22e">newSet</span>, <span style="color:#a6e22e">oldSet</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div></li>
<li>
<p>When the two StatefulSets are consistent but <code>tc.Status.PD.Phase</code> is <code>upgrade</code>, <code>newSet</code> and <code>oldSet</code> have the same template spec, and TiDB Operator continues the following two checks.</p>
</li>
</ul>
<p>For more information on these two situations, see <a href="#sync-statefulset">Sync StatefulSet</a>, Step 10.</p>
</li>
<li>
<p>It compares <code>tc.Status.PD.StatefulSet.UpdateRevision</code> and <code>tc.Status.PD.StatefulSet.CurrentRevision</code>. If the two variables are equal, the rolling upgrade operation is already completed. Then, TiDB Operator ends the upgrade process.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">PD</span>.<span style="color:#a6e22e">StatefulSet</span>.<span style="color:#a6e22e">UpdateRevision</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">PD</span>.<span style="color:#a6e22e">StatefulSet</span>.<span style="color:#a6e22e">CurrentRevision</span>
</code></pre></div></li>
<li>
<p>It checks if the <code>UpdateStrategy</code> in the StatefulSet is manually modified. If yes, follow the modified strategy.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">oldSet</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">UpdateStrategy</span>.<span style="color:#a6e22e">Type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">apps</span>.<span style="color:#a6e22e">OnDeleteStatefulSetStrategyType</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">oldSet</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">UpdateStrategy</span>.<span style="color:#a6e22e">RollingUpdate</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#a6e22e">newSet</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">UpdateStrategy</span> = <span style="color:#a6e22e">oldSet</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">UpdateStrategy</span>
    <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Warningf</span>(<span style="color:#e6db74">&#34;tidbcluster: [%s/%s] pd statefulset %s UpdateStrategy has been modified manually&#34;</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">tcName</span>, <span style="color:#a6e22e">oldSet</span>.<span style="color:#a6e22e">GetName</span>())
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div></li>
</ol>
<p>After all checks are passed, TiDB Operator begins processing each Pod and rolling upgrades the PD cluster:</p>
<ol>
<li>
<p>It checks whether the PD Pod is updated. By comparing the <code>controller-revision-hash</code> value in the Pod Label with the <code>UpdateRevision</code> value of the StatefulSet, TiDB Operator can tell whether this Pod is updated or still unprocessed. If the Pod is updated, TiDB Operator then checks whether the PD member is healthy. If the PD member is healthy, TiDB Operator moves on to the next Pod. If not, TiDB Operator returns an error and checks the health state in the next sync.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">revision</span>, <span style="color:#a6e22e">exist</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Labels</span>[<span style="color:#a6e22e">apps</span>.<span style="color:#a6e22e">ControllerRevisionHashLabelKey</span>]
    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">exist</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">RequeueErrorf</span>(<span style="color:#e6db74">&#34;tidbcluster: [%s/%s]&#39;s pd pod: [%s] has no label: %s&#34;</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">tcName</span>, <span style="color:#a6e22e">podName</span>, <span style="color:#a6e22e">apps</span>.<span style="color:#a6e22e">ControllerRevisionHashLabelKey</span>)
    }

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">revision</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">PD</span>.<span style="color:#a6e22e">StatefulSet</span>.<span style="color:#a6e22e">UpdateRevision</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">member</span>, <span style="color:#a6e22e">exist</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">PD</span>.<span style="color:#a6e22e">Members</span>[<span style="color:#a6e22e">PdName</span>(<span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">ClusterDomain</span>)]; !<span style="color:#a6e22e">exist</span> <span style="color:#f92672">||</span> !<span style="color:#a6e22e">member</span>.<span style="color:#a6e22e">Health</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">RequeueErrorf</span>(<span style="color:#e6db74">&#34;tidbcluster: [%s/%s]&#39;s pd upgraded pod: [%s] is not ready&#34;</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">tcName</span>, <span style="color:#a6e22e">podName</span>)
        }
        <span style="color:#66d9ef">continue</span>
    }
</code></pre></div></li>
<li>
<p>If <code>Pod revision != tc.Status.PD.StatefulSet.UpdateRevision</code>, the Pod is not updated yet. TiDB Operator calls the <code>upgradePDPod</code> function to process this Pod. When TiDB Operator processes the PD Leader Pod, it transfers the Leader before it continues the upgrade process.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">PD</span>.<span style="color:#a6e22e">Leader</span>.<span style="color:#a6e22e">Name</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">upgradePdName</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">PD</span>.<span style="color:#a6e22e">Leader</span>.<span style="color:#a6e22e">Name</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">upgradePodName</span> {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">targetName</span> <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">targetOrdinal</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">helper</span>.<span style="color:#a6e22e">GetMaxPodOrdinal</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">newSet</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Replicas</span>, <span style="color:#a6e22e">newSet</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ordinal</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">targetOrdinal</span> {
        <span style="color:#a6e22e">targetOrdinal</span> = <span style="color:#a6e22e">helper</span>.<span style="color:#a6e22e">GetMinPodOrdinal</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">newSet</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Replicas</span>, <span style="color:#a6e22e">newSet</span>)
    }
    <span style="color:#a6e22e">targetName</span> = <span style="color:#a6e22e">PdName</span>(<span style="color:#a6e22e">tcName</span>, <span style="color:#a6e22e">targetOrdinal</span>, <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">ClusterDomain</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">exist</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">PD</span>.<span style="color:#a6e22e">Members</span>[<span style="color:#a6e22e">targetName</span>]; !<span style="color:#a6e22e">exist</span> {
        <span style="color:#a6e22e">targetName</span> = <span style="color:#a6e22e">PdPodName</span>(<span style="color:#a6e22e">tcName</span>, <span style="color:#a6e22e">targetOrdinal</span>)
    }

    <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">targetName</span>) &gt; <span style="color:#ae81ff">0</span> {
        <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">transferPDLeaderTo</span>(<span style="color:#a6e22e">tc</span>, <span style="color:#a6e22e">targetName</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;pd upgrader: failed to transfer pd leader to: %s, %v&#34;</span>, <span style="color:#a6e22e">targetName</span>, <span style="color:#a6e22e">err</span>)
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;pd upgrader: transfer pd leader to: %s successfully&#34;</span>, <span style="color:#a6e22e">targetName</span>)
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">RequeueErrorf</span>(<span style="color:#e6db74">&#34;tidbcluster: [%s/%s]&#39;s pd member: [%s] is transferring leader to pd member: [%s]&#34;</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">tcName</span>, <span style="color:#a6e22e">upgradePdName</span>, <span style="color:#a6e22e">targetName</span>)
    }
}
<span style="color:#a6e22e">setUpgradePartition</span>(<span style="color:#a6e22e">newSet</span>, <span style="color:#a6e22e">ordinal</span>)
</code></pre></div></li>
</ol>
<h3 id="failover">Failover</h3>
<p>The PD failover logic is implemented in <code>pd_failover.go</code>. PD deletes failed Pods to fix the failure, which is different from other component failover logic.</p>
<p>Before performing failover, TiDB Operator also carries out health checks. If the PD cluster is unavailable, which means half of the PD members are unhealthy, recreating PD members cannot recover the cluster. Under such circumstances, TiDB Operator doesn't perform failover.</p>
<ol>
<li>
<p>TiDB Operator traverses the PD member health status obtained from the PD client. When the PD member is unhealthy and the duration between its last transition time and now is longer than <code>failoverDeadline</code>, the member is marked as unhealthy. Its Pod information and PVC information are recorded in <code>tc.Status.PD.FailureMembers</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">pdName</span>, <span style="color:#a6e22e">pdMember</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">PD</span>.<span style="color:#a6e22e">Members</span> {
    <span style="color:#a6e22e">podName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">pdName</span>, <span style="color:#e6db74">&#34;.&#34;</span>)[<span style="color:#ae81ff">0</span>]

    <span style="color:#a6e22e">failoverDeadline</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pdMember</span>.<span style="color:#a6e22e">LastTransitionTime</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">deps</span>.<span style="color:#a6e22e">CLIConfig</span>.<span style="color:#a6e22e">PDFailoverPeriod</span>)
    <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">exist</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">PD</span>.<span style="color:#a6e22e">FailureMembers</span>[<span style="color:#a6e22e">pdName</span>]

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pdMember</span>.<span style="color:#a6e22e">Health</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Before</span>(<span style="color:#a6e22e">failoverDeadline</span>) <span style="color:#f92672">||</span> <span style="color:#a6e22e">exist</span> {
        <span style="color:#66d9ef">continue</span>
    }

    <span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">deps</span>.<span style="color:#a6e22e">PodLister</span>.<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">ns</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">podName</span>)

    <span style="color:#a6e22e">pvcs</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">ResolvePVCFromPod</span>(<span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">deps</span>.<span style="color:#a6e22e">PVCLister</span>)

    <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">deps</span>.<span style="color:#a6e22e">Recorder</span>.<span style="color:#a6e22e">Eventf</span>(<span style="color:#a6e22e">tc</span>, <span style="color:#a6e22e">apiv1</span>.<span style="color:#a6e22e">EventTypeWarning</span>, <span style="color:#e6db74">&#34;PDMemberUnhealthy&#34;</span>, <span style="color:#e6db74">&#34;%s/%s(%s) is unhealthy&#34;</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">podName</span>, <span style="color:#a6e22e">pdMember</span>.<span style="color:#a6e22e">ID</span>)

    <span style="color:#a6e22e">pvcUIDSet</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">UID</span>]<span style="color:#66d9ef">struct</span>{})
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">pvc</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">pvcs</span> {
        <span style="color:#a6e22e">pvcUIDSet</span>[<span style="color:#a6e22e">pvc</span>.<span style="color:#a6e22e">UID</span>] = <span style="color:#66d9ef">struct</span>{}{}
    }
    <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">PD</span>.<span style="color:#a6e22e">FailureMembers</span>[<span style="color:#a6e22e">pdName</span>] = <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">PDFailureMember</span>{
        <span style="color:#a6e22e">PodName</span>:       <span style="color:#a6e22e">podName</span>,
        <span style="color:#a6e22e">MemberID</span>:      <span style="color:#a6e22e">pdMember</span>.<span style="color:#a6e22e">ID</span>,
        <span style="color:#a6e22e">PVCUIDSet</span>:     <span style="color:#a6e22e">pvcUIDSet</span>,
        <span style="color:#a6e22e">MemberDeleted</span>: <span style="color:#66d9ef">false</span>,
        <span style="color:#a6e22e">CreatedAt</span>:     <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">Now</span>(),
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">RequeueErrorf</span>(<span style="color:#e6db74">&#34;marking Pod: %s/%s pd member: %s as failure&#34;</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">podName</span>, <span style="color:#a6e22e">pdMember</span>.<span style="color:#a6e22e">Name</span>)
}
</code></pre></div></li>
<li>
<p>TiDB Operator calls the <code>tryToDeleteAFailureMember</code> function to process the <code>FailureMembers</code>. It traverses all failure members, and when it encounters a member whose <code>MemberDeleted</code> is <code>False</code>, it calls the PD client to delete the member and tries to recover the Pod.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pdFailover</span>) <span style="color:#a6e22e">tryToDeleteAFailureMember</span>(<span style="color:#a6e22e">tc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">TidbCluster</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#a6e22e">ns</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">GetNamespace</span>()
    <span style="color:#a6e22e">tcName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">GetName</span>()
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">failureMember</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">PDFailureMember</span>
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">failurePodName</span> <span style="color:#66d9ef">string</span>
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">failurePDName</span> <span style="color:#66d9ef">string</span>

    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">pdName</span>, <span style="color:#a6e22e">pdMember</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">PD</span>.<span style="color:#a6e22e">FailureMembers</span> {
        <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">pdMember</span>.<span style="color:#a6e22e">MemberDeleted</span> {
            <span style="color:#a6e22e">failureMember</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pdMember</span>
            <span style="color:#a6e22e">failurePodName</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">pdName</span>, <span style="color:#e6db74">&#34;.&#34;</span>)[<span style="color:#ae81ff">0</span>]
            <span style="color:#a6e22e">failurePDName</span> = <span style="color:#a6e22e">pdName</span>
            <span style="color:#66d9ef">break</span>
        }
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">failureMember</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;No PD FailureMembers to delete for tc %s/%s&#34;</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">tcName</span>)
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    }

    <span style="color:#a6e22e">memberID</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">ParseUint</span>(<span style="color:#a6e22e">failureMember</span>.<span style="color:#a6e22e">MemberID</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">64</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">controller</span>.<span style="color:#a6e22e">GetPDClient</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">deps</span>.<span style="color:#a6e22e">PDControl</span>, <span style="color:#a6e22e">tc</span>).<span style="color:#a6e22e">DeleteMemberByID</span>(<span style="color:#a6e22e">memberID</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;pd failover[tryToDeleteAFailureMember]: failed to delete member %s/%s(%d), error: %v&#34;</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">failurePodName</span>, <span style="color:#a6e22e">memberID</span>, <span style="color:#a6e22e">err</span>)
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;pd failover[tryToDeleteAFailureMember]: delete member %s/%s(%d) successfully&#34;</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">failurePodName</span>, <span style="color:#a6e22e">memberID</span>)
<span style="color:#f92672">...</span>
</code></pre></div><p>Delete the failed Pod.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">deps</span>.<span style="color:#a6e22e">PodLister</span>.<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">ns</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">failurePodName</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsNotFound</span>(<span style="color:#a6e22e">err</span>) {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;pd failover[tryToDeleteAFailureMember]: failed to get pod %s/%s for tc %s/%s, error: %s&#34;</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">failurePodName</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">tcName</span>, <span style="color:#a6e22e">err</span>)
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pod</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">DeletionTimestamp</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">deps</span>.<span style="color:#a6e22e">PodControl</span>.<span style="color:#a6e22e">DeletePod</span>(<span style="color:#a6e22e">tc</span>, <span style="color:#a6e22e">pod</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
            }
        }
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;pd failover[tryToDeleteAFailureMember]: failure pod %s/%s not found, skip&#34;</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">failurePodName</span>)
    }
</code></pre></div><p>Delete the PVC.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">pvc</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">pvcs</span> {
    <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">pvcUIDExist</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">failureMember</span>.<span style="color:#a6e22e">PVCUIDSet</span>[<span style="color:#a6e22e">pvc</span>.<span style="color:#a6e22e">GetUID</span>()]
    <span style="color:#75715e">// for backward compatibility, if there exists failureMembers and user upgrades operator to newer version
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// there will be failure member structures with PVCUID set from api server, we should handle this as pvcUIDExist == true
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pvc</span>.<span style="color:#a6e22e">GetUID</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">failureMember</span>.<span style="color:#a6e22e">PVCUID</span> {
        <span style="color:#a6e22e">pvcUIDExist</span> = <span style="color:#66d9ef">true</span>
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pvc</span>.<span style="color:#a6e22e">DeletionTimestamp</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">pvcUIDExist</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">deps</span>.<span style="color:#a6e22e">PVCControl</span>.<span style="color:#a6e22e">DeletePVC</span>(<span style="color:#a6e22e">tc</span>, <span style="color:#a6e22e">pvc</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;pd failover[tryToDeleteAFailureMember]: failed to delete PVC: %s/%s, error: %s&#34;</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">pvc</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">err</span>)
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;pd failover[tryToDeleteAFailureMember]: delete PVC %s/%s successfully&#34;</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">pvc</span>.<span style="color:#a6e22e">Name</span>)
    }
}
</code></pre></div><p>Mark the status of <code>tc.Status.PD.FailureMembers</code> as <code>Deleted</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">setMemberDeleted</span>(<span style="color:#a6e22e">tc</span>, <span style="color:#a6e22e">failurePDName</span>)
</code></pre></div></li>
<li>
<p><code>​​tc.PDStsDesiredReplicas()</code> obtains the number of PD StatefulSet replicas, which equals the number of StatefulSet replicas plus the deleted failure members. When syncing the StatefulSet, TiDB Operator calls the scaling-out logic to add a PD Pod for failover.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">tc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TidbCluster</span>) <span style="color:#a6e22e">GetPDDeletedFailureReplicas</span>() <span style="color:#66d9ef">int32</span> {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">deletedReplicas</span> <span style="color:#66d9ef">int32</span> = <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">failureMember</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">PD</span>.<span style="color:#a6e22e">FailureMembers</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">failureMember</span>.<span style="color:#a6e22e">MemberDeleted</span> {
            <span style="color:#a6e22e">deletedReplicas</span><span style="color:#f92672">++</span>
        }
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">deletedReplicas</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">tc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TidbCluster</span>) <span style="color:#a6e22e">PDStsDesiredReplicas</span>() <span style="color:#66d9ef">int32</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">PD</span>.<span style="color:#a6e22e">Replicas</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">GetPDDeletedFailureReplicas</span>()
}
</code></pre></div></li>
</ol>
<h2 id="other-components-control-loop">Other component's control loop</h2>
<p>Now that you know how TiDB Operator manages PD's lifecycle, I'll move on to the differences between PD and other components.</p>
<h3 id="tikv-and-tiflash">TiKV and TiFlash</h3>
<p><a href="https://docs.pingcap.com/tidb/stable/tikv-overview">TiKV</a> and <a href="https://docs.pingcap.com/tidb/stable/tiflash-overview">TiFlash</a> are two storage engines of TiDB and have a similar lifecycle management mechanism. In this section, I'll take TiKV as an example.</p>
<ul>
<li>
<p>When syncing the StatefulSet, the TiKV member manager needs to set TiKV store labels using the <code>setStoreLabelsForTiKV</code> function. This function gets the node labels and sets labels for TiKV stores via the PD client's <code>SetStoreLables</code> function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">store</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">storesInfo</span>.<span style="color:#a6e22e">Stores</span> {
    <span style="color:#a6e22e">nodeName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">NodeName</span>
    <span style="color:#a6e22e">ls</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getNodeLabels</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">deps</span>.<span style="color:#a6e22e">NodeLister</span>, <span style="color:#a6e22e">nodeName</span>, <span style="color:#a6e22e">storeLabels</span>)

    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">storeLabelsEqualNodeLabels</span>(<span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Store</span>.<span style="color:#a6e22e">Labels</span>, <span style="color:#a6e22e">ls</span>) {
        <span style="color:#a6e22e">set</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pdCli</span>.<span style="color:#a6e22e">SetStoreLabels</span>(<span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Store</span>.<span style="color:#a6e22e">Id</span>, <span style="color:#a6e22e">ls</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">continue</span>
        }
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">set</span> {
            <span style="color:#a6e22e">setCount</span><span style="color:#f92672">++</span>
            <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;pod: [%s/%s] set labels: %v successfully&#34;</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">podName</span>, <span style="color:#a6e22e">ls</span>)
        }
    }
}
</code></pre></div></li>
<li>
<p>When syncing Status, the TiKV member manager calls the PD client's <code>GetStores</code> function and obtains the TiKV store information from PD. It then categorizes the store information for later synchronization. This operation is similar to PD's syncing status, in which the PD member manager calls the <code>GetMembers</code> function and records PD member information.</p>
</li>
<li>
<p>When syncing Service, the TiKV member manager only creates headless Services for parsing TiKV Pod DNS.</p>
</li>
<li>
<p>When syncing ConfigMap, the TiKV member manager uses a template in the <code>templates.go</code> file, calls the <code>RenderTiKVStartScript</code> function to generate the TiKV start script, and calls the <code>transformTiKVConfigMap</code> function to get the TiKV configuration file.</p>
</li>
<li>
<p>When performing scaling operations, the TiKV member manager must safely take TiKV stores offline. It calls the PD client's <code>DeleteStore</code> function to delete the corresponding store from the TiKV Pod.</p>
</li>
<li>
<p>In terms of rolling upgrade, the TiKV member manager must ensure that the Region Leader is not on the Pod to be upgraded. Before the rolling upgrade, TiKV Upgrader checks whether the Pod annotation contains <code>EvictLeaderBeginTime</code> and determines whether it has performed <code>EvictLeader</code> on this Pod. If not, it calls the <code>BeginEvictLeader</code> function from the PD client and adds an evict leader scheduler to the TiKV store. The Region Leader is then evicted from the TiKV store.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#960050;background-color:#1e0010">​</span><span style="color:#960050;background-color:#1e0010">​</span><span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">evicting</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">upgradePod</span>.<span style="color:#a6e22e">Annotations</span>[<span style="color:#a6e22e">EvictLeaderBeginTime</span>]
<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">evicting</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">beginEvictLeader</span>(<span style="color:#a6e22e">tc</span>, <span style="color:#a6e22e">storeID</span>, <span style="color:#a6e22e">upgradePod</span>)
}
</code></pre></div><p>In the <code>readyToUpgrade</code> function, when the Region Leader is zero, or when the evict Leader duration exceeds <code>tc.Spec.TiKV.EvictLeaderTimeout</code>, the partition configuration in the StatefulSet <code>UpdateStrategy</code> is updated, which triggers Pod upgrade. When PD finishes the upgrade, it calls the <code>endEvictLeaderbyStoreID</code> function to end the operation.</p>
</li>
<li>
<p>When performing failover, the TiKV member manager records the timestamp of the last store state change.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">status</span>.<span style="color:#a6e22e">LastTransitionTime</span> = <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">Now</span>()
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">exist</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">status</span>.<span style="color:#a6e22e">State</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">oldStore</span>.<span style="color:#a6e22e">State</span> {
    <span style="color:#a6e22e">status</span>.<span style="color:#a6e22e">LastTransitionTime</span> = <span style="color:#a6e22e">oldStore</span>.<span style="color:#a6e22e">LastTransitionTime</span>
}
</code></pre></div><p>When the store state is <code>v1alpha1.TiKVStateDown</code> and the downtime exceeds the maximum failover timeout, the TiKV Pod is added to <code>FailureStores</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#960050;background-color:#1e0010">​</span><span style="color:#960050;background-color:#1e0010">​</span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">State</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">TiKVStateDown</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">After</span>(<span style="color:#a6e22e">deadline</span>) <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">exist</span> {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">TiKV</span>.<span style="color:#a6e22e">FailureStores</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">TiKV</span>.<span style="color:#a6e22e">FailureStores</span> = <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">TiKVFailureStore</span>{}
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">TiKV</span>.<span style="color:#a6e22e">MaxFailoverCount</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">TiKV</span>.<span style="color:#a6e22e">MaxFailoverCount</span> &gt; <span style="color:#ae81ff">0</span> {
        <span style="color:#a6e22e">maxFailoverCount</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">TiKV</span>.<span style="color:#a6e22e">MaxFailoverCount</span>
        <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">TiKV</span>.<span style="color:#a6e22e">FailureStores</span>) <span style="color:#f92672">&gt;=</span> int(<span style="color:#a6e22e">maxFailoverCount</span>) {
            <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Warningf</span>(<span style="color:#e6db74">&#34;%s/%s failure stores count reached the limit: %d&#34;</span>, <span style="color:#a6e22e">ns</span>, <span style="color:#a6e22e">tcName</span>, <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">TiKV</span>.<span style="color:#a6e22e">MaxFailoverCount</span>)
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
        }
        <span style="color:#a6e22e">tc</span>.<span style="color:#a6e22e">Status</span>.<span style="color:#a6e22e">TiKV</span>.<span style="color:#a6e22e">FailureStores</span>[<span style="color:#a6e22e">storeID</span>] = <span style="color:#a6e22e">v1alpha1</span>.<span style="color:#a6e22e">TiKVFailureStore</span>{
            <span style="color:#a6e22e">PodName</span>:   <span style="color:#a6e22e">podName</span>,
            <span style="color:#a6e22e">StoreID</span>:   <span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">ID</span>,
            <span style="color:#a6e22e">CreatedAt</span>: <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">Now</span>(),
        }
        <span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;store[%s] is Down&#34;</span>, <span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">ID</span>)
        <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">deps</span>.<span style="color:#a6e22e">Recorder</span>.<span style="color:#a6e22e">Event</span>(<span style="color:#a6e22e">tc</span>, <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">EventTypeWarning</span>, <span style="color:#a6e22e">unHealthEventReason</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#a6e22e">unHealthEventMsgPattern</span>, <span style="color:#e6db74">&#34;tikv&#34;</span>, <span style="color:#a6e22e">podName</span>, <span style="color:#a6e22e">msg</span>))
    }
}
</code></pre></div><p>When syncing TiKV StatefulSet, the number of replicas includes the number of <code>FailureStores</code>, which triggers the scaling-out logic and completes the failover operation.</p>
</li>
</ul>
<h3 id="tidb-ticdc-and-pump">TiDB, TiCDC, and Pump</h3>
<p>TiDB, TiCDC, and Pump have a similar lifecycle management mechanism. Compared to other components, their rolling upgrade is only carried out when the member is healthy.</p>
<p>During scaling, TiDB Operator needs to pay extra attention to PVC usage. When scaling in the cluster, TiDB Operator needs to add <code>deferDeleting</code> to ensure data safety; when scaling out the cluster, TiDB Operator also needs to remove the PVC.</p>
<p>In addition, TiDB Operator only supports failover logic for TiDB, but not for TiCDC or Pump.</p>
<h2 id="summary">Summary</h2>
<p>In this post, taking PD as an example, we have learned the implementation of PD's control loop and compared PD with other components. By now you should be familiar with the member manager design of major TiDB components and how TiDB Operator implements TiDB lifecycle management.</p>
<p>In the next article, we'll discuss <strong>how TiDB Operator implements backup and restore for TiDB clusters</strong>. Stay tuned!</p>
<p>If you are interested in learning more about TiDB Operator, feel free to <a href="https://slack.tidb.io/invite?team=tidb-community&amp;channel=sig-k8s&amp;ref=pingcap-blog">join our Slack channel</a> or join our discussions at <a href="https://github.com/pingcap/tidb-operator">pingcap/tidb-operator</a>.</p>
<hr>
<p>If you've missed an article in our series, you can read them here:</p>
<ul>
<li><a href="https://pingcap.com/blog/tidb-operator-source-code-reading-1-overview">TiDB Operator Source Code Reading (I): Overview</a></li>
<li><a href="https://pingcap.com/blog/tidb-operator-source-code-reading-2-operator-pattern">TiDB Operator Source Code Reading (II): Operator Pattern</a></li>
<li><a href="https://pingcap.com/blog/tidb-operator-source-code-reading-3-component-control-loop">TiDB Operator Source Code Reading (III): The Component Control Loop</a></li>
</ul>
</div>
                </div>
                <div class="article-toc"></div><div class="ssba-wrap">
    <div class="ssba">
        <a data-site="" class="ssba_twitter_share" href="http://twitter.com/share?url=https%3a%2f%2fidiks.com%2fblog%2ftidb-operator-source-code-reading-4-implement-component-control-loop%2f" target="_blank">
        
            <img src="/images/svgs/twitter-icon.svg" alt="Twitter icon" />
        </a>
        <a data-site="reddit" class="ssba_reddit_share" href="http://reddit.com/submit?url=https%3a%2f%2fidiks.com%2fblog%2ftidb-operator-source-code-reading-4-implement-component-control-loop%2f&title=TiDB%20Operator%20Source%20Code%20Reading%20%28IV%29%3a%20Implementing%20a%20Component%20Control%20Loop" target="_blank">
        
            <img src="/images/svgs/reddit-icon.svg" alt="Reddit icon" />
        </a>
        <a data-site="" class="ssba_facebook_share" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fidiks.com%2fblog%2ftidb-operator-source-code-reading-4-implement-component-control-loop%2f" target="_blank">
        
            <img src="/images/svgs/facebook-icon.svg" alt="Fackbook icon" />
        </a>
        <a data-site="linkedin" class="ssba_linkedin_share" href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fidiks.com%2fblog%2ftidb-operator-source-code-reading-4-implement-component-control-loop%2f" target="_blank">
        
            <img src="/images/svgs/linkedin-icon.svg" alt="Linkedin icon" />
        </a>
        <a data-site="hackernews" class="ssba_hackernews_share" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fidiks.com%2fblog%2ftidb-operator-source-code-reading-4-implement-component-control-loop%2f&t=TiDB%20Operator%20Source%20Code%20Reading%20%28IV%29%3a%20Implementing%20a%20Component%20Control%20Loop" target="_blank">
        
            <img src="/images/svgs/hacker-news-icon.svg" alt="Hacker News icon" />
        </a>
    </div>
</div>
<div class="trackable-btns">
                    <a href="/download" onclick="trackViews('TiDB Operator Source Code Reading (IV): Implementing a Component Control Loop', 'download-tidb-btn-bottom')"><button>Download
                        TiDB</button></a>
                    <a href="https://share.hsforms.com/1e2W03wLJQQKPd1d9rCbj_Q2npzm"
                      onclick="trackViews('TiDB Operator Source Code Reading (IV): Implementing a Component Control Loop', 'subscribe-blog-btn-bottom')"><button>Subscribe to
                        Blog</button></a>
                </div>
            </div>
            <div class="sidebar-page">
                <div class="sticky-sidebar">
                    <p class="toc-title">What’s on this page</p>
                    <div id="smart_toc_wrapper"></div>
                </div>
            </div>
        </div>
    </div>
<footer>
    <div class="container">
        <div class="flex-list-wrap">
            <div class="flex-list">
                <h4 class="list-title"><strong>Product</strong></h4>
                <ul>
                <li><a href="/docs/v3.0/">TiDB</a></li>
                <li><a href="/docs/v3.0/reference/tispark/">TiSpark</a></li>
                <li><a href="/docs/v3.0/roadmap/">Roadmap</a></li>
                </ul>
            </div>
            <div class="flex-list">
                <h4 class="list-title"><strong>Docs</strong></h4>
                <ul>
                <li><a href="/docs/stable/quick-start-with-tidb/">Quick Start</a></li>
                <li><a href="/blog/2017-07-24-tidbbestpractice/">Best Practices</a></li>
                <li><a href="/docs/stable/faq/tidb/">FAQ</a></li>
                <li><a href="/docs/stable/reference/tools/user-guide/">TiDB Tools</a></li>
                <li><a href="/docs/dev/releases/rn/">Release Notes</a></li>
                </ul>
            </div>
            <div class="flex-list">
                <h4 class="list-title"><strong>Resources</strong></h4>
                <ul>
                <li><a href="/blog/">Blog</a></li>
                <li><a href="/weekly/">Monthly</a></li>
                <li><a href="https://github.com/idiks" target="_blank">GitHub</a></li>
                <li><a href="/community">TiDB Community</a></li>
                </ul>
            </div>
            <div class="flex-list">
                <h4 class="list-title"><strong>Company</strong></h4>
                <ul>
                <li><a href="/about/">About</a></li>
                <li><a href="/jobs" target="_blank">Careers</a></li>
                <li><a href="/news/">News</a></li>
                <li><a href="/contact-us/">Contact Us</a></li>
                <li><a href="/privacy-policy/">Privacy Policy</a></li>
                <li><a href="/terms-of-service/">Terms of Service</a></li>
                </ul>
            </div>
        </div>
        <div class="contact-list-wrap">
            <div class="flex-list">
                <h4 class="list-title"><strong>Connect</strong></h4>
                <ul>
                <li><a href="https://twitter.com/idiks" class="twitter" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" width="18" height="19"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"/></svg> Twitter</a></li>
                <li><a href="https://www.linkedin.com/company/idiks/" class="linkedin" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="16" viewBox="0 0 438.536 438.535"><path d="M5.424 145.895H99.64v282.932H5.424zM408.842 171.739c-19.791-21.604-45.967-32.408-78.512-32.408-11.991 0-22.891 1.475-32.695 4.427-9.801 2.95-18.079 7.089-24.838 12.419-6.755 5.33-12.135 10.278-16.129 14.844-3.798 4.337-7.512 9.389-11.136 15.104v-40.232h-93.935l.288 13.706c.193 9.139.288 37.307.288 84.508 0 47.205-.19 108.777-.572 184.722h93.931V270.942c0-9.705 1.041-17.412 3.139-23.127 4-9.712 10.037-17.843 18.131-24.407 8.093-6.572 18.13-9.855 30.125-9.855 16.364 0 28.407 5.662 36.117 16.987 7.707 11.324 11.561 26.98 11.561 46.966V428.82h93.931V266.664c-.007-41.688-9.897-73.328-29.694-94.925zM53.103 9.708c-15.796 0-28.595 4.619-38.4 13.848C4.899 32.787 0 44.441 0 58.529 0 72.42 4.758 84.034 14.275 93.358c9.514 9.325 22.078 13.99 37.685 13.99h.571c15.99 0 28.887-4.661 38.688-13.99 9.801-9.324 14.606-20.934 14.417-34.829-.19-14.087-5.047-25.742-14.561-34.973C81.562 14.323 68.9 9.708 53.103 9.708z"/></svg> LinkedIn</a></li>
                <li><a href="https://www.reddit.com/r/idiks/" class="reddit" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 279.748 279.748" width="18" height="18"><path d="M279.748 133.142c0-19.299-15.701-35-35-35-10.768 0-20.674 4.812-27.279 13.064-18.532-8.431-39.663-13.626-62.015-15.271l19.206-60.692 42.895 9.294c3.285 12.782 14.901 22.258 28.693 22.258 16.336 0 29.627-13.29 29.627-29.626 0-16.336-13.291-29.627-29.627-29.627-11.801 0-21.999 6.941-26.759 16.95l-49.497-10.725a10.002 10.002 0 0 0-11.651 6.756L134.636 95.43c-26.164.638-50.988 6.053-72.356 15.775-6.606-8.251-16.512-13.063-27.28-13.063-19.299 0-35 15.701-35 35 0 9.373 3.683 18.173 10.222 24.709-3.9 8.37-5.875 17.076-5.875 25.936 0 24.048 14.396 46.492 40.538 63.199 25.447 16.264 59.183 25.221 94.989 25.221 35.808 0 69.542-8.957 94.989-25.221 26.142-16.707 40.538-39.151 40.538-63.199 0-8.859-1.975-17.565-5.875-25.936 6.539-6.537 10.222-15.336 10.222-24.709zM15.369 145.139c-2.212-3.59-3.369-7.688-3.369-11.997 0-12.682 10.317-23 23-23 5.444 0 10.558 1.851 14.649 5.258-14.622 8.302-26.132 18.289-34.28 29.739zm52.671 20.266c0-13.785 11.215-25 25-25s25 11.215 25 25-11.215 25-25 25-25-11.215-25-25zm123.119 57.054c-9.745 10.637-29.396 17.244-51.285 17.244-21.888 0-41.539-6.607-51.284-17.244a9.937 9.937 0 0 1-2.617-7.192 9.933 9.933 0 0 1 3.235-6.937 9.974 9.974 0 0 1 6.754-2.627c2.797 0 5.484 1.183 7.373 3.244 5.803 6.333 20.827 10.756 36.539 10.756s30.737-4.423 36.539-10.756a10.022 10.022 0 0 1 7.374-3.244c2.508 0 4.906.933 6.755 2.627a9.928 9.928 0 0 1 3.234 6.937 9.933 9.933 0 0 1-2.617 7.192zm-4.451-32.054c-13.785 0-25-11.215-25-25s11.215-25 25-25 25 11.215 25 25-11.215 25-25 25zm77.671-45.266c-8.147-11.45-19.657-21.436-34.28-29.739 4.092-3.408 9.205-5.258 14.649-5.258 12.683 0 23 10.318 23 23 0 4.309-1.157 8.407-3.369 11.997z"/></svg>Reddit</a></li>
                <li><a href="https://groups.google.com/forum/#!forum/idiks-user" class="google-plus" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 491.858 491.858" width="18" height="20"><path d="M377.472 224.957H201.319v58.718H308.79c-16.032 51.048-63.714 88.077-120.055 88.077-69.492 0-125.823-56.335-125.823-125.824 0-69.492 56.333-125.823 125.823-125.823 34.994 0 66.645 14.289 89.452 37.346l42.622-46.328c-34.04-33.355-80.65-53.929-132.074-53.929C84.5 57.193 0 141.693 0 245.928s84.5 188.737 188.736 188.737c91.307 0 171.248-64.844 188.737-150.989v-58.718l-.001-.001zM491.858 224.857h-36.031v-36.031h-30.886v36.031H388.91v30.883h36.031v36.032h30.886V255.74h36.031z"/></svg>Google Group</a></li>
                <li><a href="https://stackoverflow.com/questions/tagged/idiks" class="stack-overflow" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="17" viewBox="0 0 547.597 547.597"><path d="M140.81 475.111h.024l189.91-.269c8.434-.013 15.3-6.886 15.3-15.318v-21.298c0-8.428-6.854-15.288-15.3-15.288l-189.91.264c-8.433.012-15.3 6.885-15.3 15.318v21.31c.001 8.427 6.855 15.281 15.276 15.281z"/><path d="M58.667 517.854c.073 29.26.073 29.449 3.072 29.449h.055l10.612.294h.086s85.814 0 171.629-.036c42.914-.019 85.821-.05 118-.092 16.09-.019 29.505-.043 38.887-.074 17.803-.055 17.803-.055 17.803-3.072l.3-10.697V333.299c0-8.434-6.866-15.3-15.3-15.3h-11.909c-8.434 0-15.3 6.866-15.3 15.3V496.22c0 5.062-4.119 9.18-9.181 9.18H110.51c-5.061 0-9.18-4.118-9.18-9.18V333.299c0-8.434-6.867-15.3-15.3-15.3H73.82c-8.433 0-15.3 6.86-15.3 15.3 0 23.342.012 76.084.055 122.981.019 23.447.05 45.442.092 61.574z"/><path d="M142.322 397.399l189.402 17.467c.478.043.948.062 1.413.062 7.956 0 14.468-5.985 15.159-13.917l1.83-21.096c.729-8.396-5.508-15.851-13.898-16.628l-189.102-17.461c-8.593-.795-15.869 5.441-16.653 13.825l-1.97 21.108a15.172 15.172 0 0 0 3.452 11.181 15.19 15.19 0 0 0 10.367 5.459zM437.636 208.849a15.253 15.253 0 0 0 17.694 12.443l21.065-3.678c8.311-1.451 13.898-9.395 12.454-17.706l-32.504-187.23c-1.42-8.207-9.21-13.917-17.692-12.448l-21.065 3.678c-8.311 1.451-13.898 9.395-12.454 17.705l32.502 187.236zM190.333 194.375l163.6 96.708a15.28 15.28 0 0 0 7.778 2.136c5.393 0 10.447-2.876 13.183-7.509l10.876-18.36c2.08-3.519 2.674-7.631 1.658-11.591a15.18 15.18 0 0 0-7.032-9.358l-163.6-96.714c-7.014-4.149-16.836-1.597-20.967 5.374l-10.869 18.36a15.2 15.2 0 0 0-1.658 11.591 15.21 15.21 0 0 0 7.031 9.363zM387.525 240.501a15.276 15.276 0 0 0 12.626 6.659c3.091 0 6.077-.924 8.635-2.681l17.405-11.934c6.953-4.768 8.752-14.314 4.015-21.292L323.29 54.104c-4.584-6.732-14.498-8.623-21.236-3.984l-17.737 12.21c-6.945 4.779-8.727 14.327-3.971 21.291l107.179 156.88zM154.482 302.319l183.465 49.156c1.298.349 2.632.526 3.966.526 6.903 0 12.98-4.67 14.762-11.347l5.508-20.624c2.179-8.152-2.681-16.555-10.826-18.74l-183.465-49.162c-8.017-2.148-16.604 2.852-18.728 10.826l-5.508 20.63c-2.179 8.142 2.68 16.551 10.826 18.735z"/></svg>Stack Overflow</a></li>
                </ul>
            </div>
            <div class="subscribe">
                <a href="https://share.hsforms.com/1e2W03wLJQQKPd1d9rCbj_Q2npzm"><button class="btn btn-subscribe f-tc">Subscribe to Blog</button></a>
            </div>
        </div>
    </div>
    <div class="container copyright-container">
        <p class="copyright">&copy; 2025 iDIKS. All Rights Reserved.</p>
        <a href="/blog-cn" class="copyright-btn-lang" id="lang">中文</a>
    </div>
</footer>
<button class="back-to-top" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 284.929 284.929"><path d="M282.082 195.285L149.028 62.24c-1.901-1.903-4.088-2.856-6.562-2.856s-4.665.953-6.567 2.856L2.856 195.285C.95 197.191 0 199.378 0 201.853c0 2.474.953 4.664 2.856 6.566l14.272 14.271c1.903 1.903 4.093 2.854 6.567 2.854s4.664-.951 6.567-2.854l112.204-112.202 112.208 112.209c1.902 1.903 4.093 2.848 6.563 2.848 2.478 0 4.668-.951 6.57-2.848l14.274-14.277c1.902-1.902 2.847-4.093 2.847-6.566.001-2.476-.944-4.666-2.846-6.569z" fill="#FFF"/></svg>
</button>
</div><div class="overlay"></div><script src="https://static.idiks.com/js/jquery.min.js"></script><script type="text/javascript" src="/js/vendor/lazyload.min.js"></script>
    <script type="text/javascript" src="/js/doc.js"></script>
    <script type="text/javascript" src="/js/anchor.js"></script><script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><script src="https://browser.sentry-cdn.com/5.11.0/bundle.min.js" integrity="sha384-jbFinqIbKkHNg+QL+yxB4VrBC0EAPTuaLGeRT0T+NfEV89YC6u1bKxHLwoo+/xxY" crossorigin="anonymous"></script><script>Sentry.init({ 
            dsn: 'https://3f28ed393c5545daa74496b3cdb2e9ba@sentry.io/1887163' 
        });</script><script src="/js/app.js"></script></body></html>