<!doctype html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<script>
window.ga =
    window.ga ||
    function() {
        ;(ga.q = ga.q || []).push(arguments)
    }
ga.l = +new Date()
ga('create', 'UA-99991864-4', 'auto')
ga('send', 'pageview')
</script>
<script async src="https://static.idiks.com/js/ga-analytics.js"></script>



<link rel="stylesheet" href="https://static.idiks.com/style/github-markdown.css">


<link rel="stylesheet" href="/css/doc.css">

    
    <title>How We Trace a KV Database with Less than 5% Performance Impact |&nbsp;TiDB</title><link rel="icon" href="/images/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<meta name="description" content="As a key-value database, TiKV has much higher performance requirements than a regular application, so tracing tools must have minimal impact. Learn how we trace TiKV requests while impacting performance less than 5%.">
<meta name="robots" content="noodp">
<meta name="keywords" content="TiDB, MySQL, HTAP, Open Source, Cloud-Native, NewSQL, Aurora Alternative">
<meta property="og:locale" content="en_US">
<meta property="og:type" content="website">
<meta property="og:title" content="How We Trace a KV Database with Less than 5% Performance Impact | TiDB">
<meta property="og:description" content="As a key-value database, TiKV has much higher performance requirements than a regular application, so tracing tools must have minimal impact. Learn how we trace TiKV requests while impacting performance less than 5%.">
<meta property="og:url" content="https://idiks.com/blog/how-we-trace-a-kv-database-with-less-than-5-percent-performance-impact/">
<meta property="og:site_name" content="MySQL at Scale. No more manual sharding">
<meta property="og:image" content="/images/blog/key-value-database-tracing-tools.jpg">
<meta property="og:image:secure_url" content="/images/blog/key-value-database-tracing-tools.jpg"><meta name="twitter:card" content="summary_large_image">
<meta name="og:image:width" content="1200">
<meta name="og:image:height" content="600"><meta name="twitter:description" content="As a key-value database, TiKV has much higher performance requirements than a regular application, so tracing tools must have minimal impact. Learn how we trace TiKV requests while impacting performance less than 5%.">
<meta name="twitter:title" content="How We Trace a KV Database with Less than 5% Performance Impact | TiDB">
<meta name="twitter:site" content="@pingcap">
<meta name="twitter:image" content="https://static.idiks.com/images/blog/key-value-database-tracing-tools.jpg"><meta name="twitter:creator" content="@pingcap">





<script type="application/ld+json">
{
    "@context": "http:\/\/schema.org",
    "@type": "WebSite",
    "url": "https:\/\/pingcap.com\/",
    "name": "PingCAP",
    "potentialAction": {
        "@type": "SearchAction",
        "target": "https:\/\/pingcap.com\/?s={search_term_string}",
        "query-input": "required name=search_term_string"
    }
}
</script>


<script>
    (function(){
        var bp = document.createElement('script');
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>


<script type="text/javascript" async src="https://accounts.pingcap.com/static/pingcap_sso/js/track.beta.js"></script>
    
<link rel="preload" href="https://static.idiks.com/fonts/lato/lato-regular-webfont.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://static.idiks.com/fonts/lato/lato-regular-webfont.woff" as="font" type="font/woff" crossorigin="anonymous">
<link rel="preload" href="https://static.idiks.com/fonts/lato/lato-regular-webfont.ttf" as="font" type="font/ttf" crossorigin="anonymous">
<link rel="preload" href="https://static.idiks.com/fonts/titilliumweb/titilliumweb-regular-webfont.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://static.idiks.com/fonts/titilliumweb/titilliumweb-regular-webfont.woff" as="font" type="font/woff" crossorigin="anonymous">
<link rel="preload" href="https://static.idiks.com/fonts/titilliumweb/titilliumweb-regular-webfont.ttf" as="font" type="font/ttf" crossorigin="anonymous">

<link rel="preload" href="https://static.idiks.com/js/jquery.min.js" as="script">


<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="https://static.idiks.com/style/docsearch.min.css">
<script type="text/javascript">
var trackOutboundLink = function(url) {
  var redirectTriggered = false
  ga('send', 'event', 'outbound', 'click', url, {
    hitCallback: function() {
      redirectTriggered = true
      document.location = url
    }
  })
  setTimeout(function() {
    if (!redirectTriggered) {
      document.location = url
    }
  }, 1500)
}

var trackViews = function(btn_type, event_category) {
  var event_label = btn_type
  var eventCategory = event_category
  ga('send', 'event', {
    'eventCategory': eventCategory,
    'eventAction': 'click',
    'eventLabel': event_label,
    'transport': 'beacon'
  });
}
</script>
<script>if (location.pathname === '/') {
        if (location.hostname === 'idiks.github.io') {
            location.href = '/en/'
        }
    }</script></head>       <body data-lang="en" ><div id="page-content">

<header role="navigation" class="fixed-top">
    <div class="container">
        <a class="nav-brand" href="/en"><img src="/images/pingcap-logo.png" alt="PingCAP"></a>
        <div class="nav-wrapper">
            <div class="navigation">
                <ul>
                <li ><a class="a-en" href="https://idiks.com">Cloud</a></li>
                <li ><a class="a-en" class="tidb-academy"
                    href="/tidb-academy">iDIKS Academy</a></li>
                <li class="docs-type-selector " id="docsTypeSelector">
                    <a class="header-doc-nav" href="#">Docs</a>
                    <div class="header-dropdown-menu" id="docsTypeSelectorItem">
                        <a class="header-dropdown-item" href="/docs/stable/">TiDB</a>
                        <a class="header-dropdown-item" href="/docs/tidb-in-kubernetes/stable/">TiDB in Kubernetes</a>
                        <a class="header-dropdown-item" href="/docs/tidb-data-migration/stable/">TiDB Data Migration (DM)</a>
                    </div>
                </li>
                
                <li ><a class="a-en" href="/success-stories">Success
                    Stories</a></li>
                <li class="sel" ><a class="a-en" href="/blog">Blog</a></li>
                <li ><a class="link-download link-download-en" href="/download">Free Download</a></li>
                </ul>
            </div>
            <div class="global-search">
                
                
                
                <div class="search-wrapper">
    <span class="icon-search"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#fff" viewBox="0 0 67.125 67.125"><path d="M23.902 0C11.01 0 .523 10.488.523 23.38c0 12.891 10.487 23.379 23.379 23.379a23.258 23.258 0 0 0 14.471-5.037l24.816 24.817c.391.391.902.586 1.414.586s1.023-.195 1.414-.586a2 2 0 0 0 0-2.828L41.293 38.985c3.721-4.142 5.989-9.613 5.989-15.605C47.282 10.488 36.794 0 23.902 0zM4.523 23.38C4.523 12.694 13.216 4 23.902 4c10.687 0 19.38 8.694 19.38 19.38 0 5.396-2.221 10.279-5.791 13.795a1.959 1.959 0 0 0-.488.349 2.003 2.003 0 0 0-.271.343C33.31 40.9 28.825 42.76 23.903 42.76c-10.686-.001-19.38-8.695-19.38-19.38z"/><path d="M24.075 8.591c-8.25 0-14.962 6.712-14.962 14.962a2 2 0 0 0 4 0c0-6.044 4.918-10.962 10.962-10.962a2 2 0 0 0 0-4z"/></svg></span>
    <input data-lang="en" data-type="" type="search" id="search-input" name="q"
        placeholder="Search TiDB Docs">
</div>

<script>
    const inputNode = document.getElementById("search-input")

    inputNode.addEventListener('keyup', ({key}) => {
        if (key === "Enter") {
            if ($('#search-input').data('lang') == 'cn') {
                lang = 'zh'
            }

            const query = $('#search-input').val()
            if (query) {
                url = "https://idiks.com/docs" + (lang == 'zh' ? 'zh/' : '') + "search/?lang=" + lang + "&type=tidb&version=v4.0&q=" + query
                window.location.href = url
            }
        }
    })
</script>

            </div>
        </div>
        <div class="nav-btn nav-slider">
            <i class="material-icons"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 459 459"><path d="M0 382.5h459v-51H0v51zM0 255h459v-51H0v51zM0 76.5v51h459v-51H0z" fill="#FFF"/></svg></i>
        </div>
    </div>
</header>



<nav class="mobile-sidebar">
    <div class="nav-header">
        <div class="logo-wrap">
        <a class="nav-brand" href="/en"><img src="/images/pingcap-logo.png" alt="PingCAP"></a>
        </div>
    </div>
    <ul class="ul-base">
        <li ><a href="https://idiks.com/">Cloud</a></li>
        <li ><a class="tidb-academy" href="/tidb-academy">TiDB Academy</a></li>
        <li class="docs-type-selector " id="docsTypeSelector">
            <p class="header-doc-nav">Docs</p>
            <div class="header-dropdown-menu" id="docsTypeSelectorItem">
                <a class="header-dropdown-item" href="/docs/stable/">TiDB</a>
                <a class="header-dropdown-item" href="/docs/tidb-in-kubernetes/stable/">TiDB in Kubernetes</a>
                <a class="header-dropdown-item" href="/docs/tidb-data-migration/stable/">TiDB Data Migration (DM)</a>
            </div>
        </li>
        <li ><a href="/success-stories">Success Stories</a></li>
        <li class="sel"><a href="/blog">Blog</a></li>
        <li><a class="link-download" href="/download">Free Download</a></li>
    </ul>
    <div class="nav-footer">
        <div class="contact-list-wrap">
        <div class="flex-list">
            <h4 class="list-title"><strong>Contact</strong></h4>
            <ul class="social ul-base">
            <li><a href="https://twitter.com/PingCAP" class="twitter" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" width="18" height="18"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"/></svg></a></li>
            <li><a href="https://www.linkedin.com/company/pingcap/" class="linkedin" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 438.536 438.535"><path d="M5.424 145.895H99.64v282.932H5.424zM408.842 171.739c-19.791-21.604-45.967-32.408-78.512-32.408-11.991 0-22.891 1.475-32.695 4.427-9.801 2.95-18.079 7.089-24.838 12.419-6.755 5.33-12.135 10.278-16.129 14.844-3.798 4.337-7.512 9.389-11.136 15.104v-40.232h-93.935l.288 13.706c.193 9.139.288 37.307.288 84.508 0 47.205-.19 108.777-.572 184.722h93.931V270.942c0-9.705 1.041-17.412 3.139-23.127 4-9.712 10.037-17.843 18.131-24.407 8.093-6.572 18.13-9.855 30.125-9.855 16.364 0 28.407 5.662 36.117 16.987 7.707 11.324 11.561 26.98 11.561 46.966V428.82h93.931V266.664c-.007-41.688-9.897-73.328-29.694-94.925zM53.103 9.708c-15.796 0-28.595 4.619-38.4 13.848C4.899 32.787 0 44.441 0 58.529 0 72.42 4.758 84.034 14.275 93.358c9.514 9.325 22.078 13.99 37.685 13.99h.571c15.99 0 28.887-4.661 38.688-13.99 9.801-9.324 14.606-20.934 14.417-34.829-.19-14.087-5.047-25.742-14.561-34.973C81.562 14.323 68.9 9.708 53.103 9.708z"/></svg></a></li>
            <li><a href="https://www.reddit.com/r/TiDB/" class="reddit" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 279.748 279.748" width="18" height="18"><path d="M279.748 133.142c0-19.299-15.701-35-35-35-10.768 0-20.674 4.812-27.279 13.064-18.532-8.431-39.663-13.626-62.015-15.271l19.206-60.692 42.895 9.294c3.285 12.782 14.901 22.258 28.693 22.258 16.336 0 29.627-13.29 29.627-29.626 0-16.336-13.291-29.627-29.627-29.627-11.801 0-21.999 6.941-26.759 16.95l-49.497-10.725a10.002 10.002 0 0 0-11.651 6.756L134.636 95.43c-26.164.638-50.988 6.053-72.356 15.775-6.606-8.251-16.512-13.063-27.28-13.063-19.299 0-35 15.701-35 35 0 9.373 3.683 18.173 10.222 24.709-3.9 8.37-5.875 17.076-5.875 25.936 0 24.048 14.396 46.492 40.538 63.199 25.447 16.264 59.183 25.221 94.989 25.221 35.808 0 69.542-8.957 94.989-25.221 26.142-16.707 40.538-39.151 40.538-63.199 0-8.859-1.975-17.565-5.875-25.936 6.539-6.537 10.222-15.336 10.222-24.709zM15.369 145.139c-2.212-3.59-3.369-7.688-3.369-11.997 0-12.682 10.317-23 23-23 5.444 0 10.558 1.851 14.649 5.258-14.622 8.302-26.132 18.289-34.28 29.739zm52.671 20.266c0-13.785 11.215-25 25-25s25 11.215 25 25-11.215 25-25 25-25-11.215-25-25zm123.119 57.054c-9.745 10.637-29.396 17.244-51.285 17.244-21.888 0-41.539-6.607-51.284-17.244a9.937 9.937 0 0 1-2.617-7.192 9.933 9.933 0 0 1 3.235-6.937 9.974 9.974 0 0 1 6.754-2.627c2.797 0 5.484 1.183 7.373 3.244 5.803 6.333 20.827 10.756 36.539 10.756s30.737-4.423 36.539-10.756a10.022 10.022 0 0 1 7.374-3.244c2.508 0 4.906.933 6.755 2.627a9.928 9.928 0 0 1 3.234 6.937 9.933 9.933 0 0 1-2.617 7.192zm-4.451-32.054c-13.785 0-25-11.215-25-25s11.215-25 25-25 25 11.215 25 25-11.215 25-25 25zm77.671-45.266c-8.147-11.45-19.657-21.436-34.28-29.739 4.092-3.408 9.205-5.258 14.649-5.258 12.683 0 23 10.318 23 23 0 4.309-1.157 8.407-3.369 11.997z"/></svg></a></li>
            <li><a href="https://groups.google.com/forum/#!forum/tidb-user" class="google-plus" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 491.858 491.858" width="18" height="18"><path d="M377.472 224.957H201.319v58.718H308.79c-16.032 51.048-63.714 88.077-120.055 88.077-69.492 0-125.823-56.335-125.823-125.824 0-69.492 56.333-125.823 125.823-125.823 34.994 0 66.645 14.289 89.452 37.346l42.622-46.328c-34.04-33.355-80.65-53.929-132.074-53.929C84.5 57.193 0 141.693 0 245.928s84.5 188.737 188.736 188.737c91.307 0 171.248-64.844 188.737-150.989v-58.718l-.001-.001zM491.858 224.857h-36.031v-36.031h-30.886v36.031H388.91v30.883h36.031v36.032h30.886V255.74h36.031z"/></svg></a></li>
            <li><a href="https://stackoverflow.com/questions/tagged/tidb" class="stack-overflow" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 547.597 547.597"><path d="M140.81 475.111h.024l189.91-.269c8.434-.013 15.3-6.886 15.3-15.318v-21.298c0-8.428-6.854-15.288-15.3-15.288l-189.91.264c-8.433.012-15.3 6.885-15.3 15.318v21.31c.001 8.427 6.855 15.281 15.276 15.281z"/><path d="M58.667 517.854c.073 29.26.073 29.449 3.072 29.449h.055l10.612.294h.086s85.814 0 171.629-.036c42.914-.019 85.821-.05 118-.092 16.09-.019 29.505-.043 38.887-.074 17.803-.055 17.803-.055 17.803-3.072l.3-10.697V333.299c0-8.434-6.866-15.3-15.3-15.3h-11.909c-8.434 0-15.3 6.866-15.3 15.3V496.22c0 5.062-4.119 9.18-9.181 9.18H110.51c-5.061 0-9.18-4.118-9.18-9.18V333.299c0-8.434-6.867-15.3-15.3-15.3H73.82c-8.433 0-15.3 6.86-15.3 15.3 0 23.342.012 76.084.055 122.981.019 23.447.05 45.442.092 61.574z"/><path d="M142.322 397.399l189.402 17.467c.478.043.948.062 1.413.062 7.956 0 14.468-5.985 15.159-13.917l1.83-21.096c.729-8.396-5.508-15.851-13.898-16.628l-189.102-17.461c-8.593-.795-15.869 5.441-16.653 13.825l-1.97 21.108a15.172 15.172 0 0 0 3.452 11.181 15.19 15.19 0 0 0 10.367 5.459zM437.636 208.849a15.253 15.253 0 0 0 17.694 12.443l21.065-3.678c8.311-1.451 13.898-9.395 12.454-17.706l-32.504-187.23c-1.42-8.207-9.21-13.917-17.692-12.448l-21.065 3.678c-8.311 1.451-13.898 9.395-12.454 17.705l32.502 187.236zM190.333 194.375l163.6 96.708a15.28 15.28 0 0 0 7.778 2.136c5.393 0 10.447-2.876 13.183-7.509l10.876-18.36c2.08-3.519 2.674-7.631 1.658-11.591a15.18 15.18 0 0 0-7.032-9.358l-163.6-96.714c-7.014-4.149-16.836-1.597-20.967 5.374l-10.869 18.36a15.2 15.2 0 0 0-1.658 11.591 15.21 15.21 0 0 0 7.031 9.363zM387.525 240.501a15.276 15.276 0 0 0 12.626 6.659c3.091 0 6.077-.924 8.635-2.681l17.405-11.934c6.953-4.768 8.752-14.314 4.015-21.292L323.29 54.104c-4.584-6.732-14.498-8.623-21.236-3.984l-17.737 12.21c-6.945 4.779-8.727 14.327-3.971 21.291l107.179 156.88zM154.482 302.319l183.465 49.156c1.298.349 2.632.526 3.966.526 6.903 0 12.98-4.67 14.762-11.347l5.508-20.624c2.179-8.152-2.681-16.555-10.826-18.74l-183.465-49.162c-8.017-2.148-16.604 2.852-18.728 10.826l-5.508 20.63c-2.179 8.142 2.68 16.551 10.826 18.735z"/></svg></a></li>
            </ul>
        </div>
        <div class="subscribe">
            <a href="https://share.hsforms.com/1e2W03wLJQQKPd1d9rCbj_Q2npzm"><button class="btn btn-subscribe f-tc" style="margin-left: 0.75rem;">Subscribe to Blog</button></a>
        </div>
        </div>
        <div class="container">
        <a href="/blog-cn" class="btn-lang" id="lang">中文</a>
        </div>
    </div>
</nav>

<div class="blog">
        <div class="blogArticle__container">
            
            <div class="archive"><div class="article-nav">
                            <a href="/blog/#Engineering">BLOG HOME</a> <span> > </span>Engineering</div><div class="content markdown-body">
                    <h1 class="title">How We Trace a KV Database with Less than 5% Performance Impact</h1>
                    <ul class="blog-post-meta">
                        <li class="meta-item">
                            <img src="/images/svgs/icon-date.svg" alt="Date icon">Wed, Jun 30, 2021</li>
                        <li class="meta-item">
                            <img src="/images/svgs/icon-writer.svg" alt="Pen icon">Zhenchi Zhong</li>
                    </ul>
                    <div class="blog-text"><p><strong>Author:</strong> <a href="https://github.com/zhongzc">Zhenchi Zhong</a> (Software Engineer at PingCAP)</p>
<p><strong>Transcreator:</strong> <a href="https://github.com/CaitinChen">Caitin Chen</a>; <strong>Editor:</strong> Tom Dewan</p>
<p><img src="media/key-value-database-tracing-tools.jpg" alt="Key-value database tracing"></p>
<p><a href="https://tikv.org/">TiKV</a> is a distributed key-value database. It has higher performance requirements than a regular application, so tracing tools must have minimal impact. This article describes <strong>how we achieved tracing all requests&rsquo; time consumption in TiKV with less than 5% performance impact</strong>.</p>
<h2 id="background-knowledge">Background knowledge</h2>
<p>Logs, metrics, and traces are the three pillars of system observability. The following figure shows their relationship:</p>
<p><img src="media/logs-metrics-traces.jpg" alt="Logs, metrics, and traces"></p>
<div class="caption-center"> Logs, metrics, and traces </div>
<ul>
<li>Logs record discrete error and status information.</li>
<li>Metrics record and present aggregatable data.</li>
<li>Traces are a series of events for a single request.</li>
</ul>
<p>TiKV has a complete log and metric system, but lacks traces. Therefore, when we troubleshoot TiKV and TiKV's SQL layer, <a href="https://docs.pingcap.com/tidb/stable">TiDB</a>, we may encounter these issues:</p>
<ul>
<li><strong>There is no correlation between observation data.</strong> To trace and diagnose the system, you must understand all the operations in a request and their corresponding metrics. Few people have such comprehensive knowledge.</li>
<li><strong>It's difficult to trace request jitters.</strong> Monitoring metrics such as AVG, P99, and MAX don't reflect requests&rsquo; performance jitter when request payloads are mixed together.</li>
</ul>
<p><strong>Tracing solves the two problems.</strong> Now, I'll share in detail how we implemented high-performance tracing in TiKV. It is still an experimental feature in TiKV, and, to open it, you need a specific code branch. If you're interested, follow <a href="https://github.com/tikv/tikv/pull/8981">Introduce tracing framework (#8981)</a> on GitHub.</p>
<h2 id="basic-concepts">Basic concepts</h2>
<p>Tracing shows the execution path of a request in the system. For example, the following figure is a trace of an SQL statement's execution process from TiDB to TiKV:</p>
<p><img src="media/trace-sql-statement-execution.jpg" alt="Trace an SQL statement's execution"></p>
<div class="caption-center"> Tracing an SQL statement's execution </div>
<p>From this figure, we can learn the following information about the <code>INSERT INTO t VALUES (1), (2), (3);</code> statement:</p>
<ul>
<li>When TiDB processes this request, it performs three steps: compiling, planning, and executing.</li>
<li>When TiDB executes this statement, it calls TiKV's Prewrite remote procedure call (RPC) and Commit RPC.</li>
<li>The request takes 5 ms.</li>
</ul>
<p>In the figure, a box represents an event called a &ldquo;span.&rdquo; Each span contains:</p>
<ul>
<li>An event name</li>
<li>Start and end timestamps</li>
</ul>
<p>Spans are hierarchical, forming a parent-child relationship or a sequence relationship, as shown in the <a href="https://www.jaegertracing.io/docs/1.23/architecture/">figure</a> below:</p>
<p><img src="media/span.jpg" alt="Spans"></p>
<div class="caption-center"> Spans </div>
<h2 id="implementation">Implementation</h2>
<p>In this article, unless otherwise specified, we used the following test platform:</p>
<ul>
<li>CPU: Intel Core i7-8700</li>
<li>Linux distros: Ubuntu 20.04</li>
<li>Linux kernel: 5.4</li>
<li>Memory: 32 GB</li>
<li>Disk: NVM Express<sup>®</sup> (NVMe) SSD</li>
</ul>
<p>TiKV is written in Rust. The Rust community has several off-the-shelf tracing libraries, for example, <a href="https://github.com/tokio-rs/tracing">tokio-tracing</a>, <a href="https://github.com/sile/rustracing">rustracing</a>, and <a href="https://github.com/open-telemetry/opentelemetry-rust">open-telemetry</a>. They all follow the OpenTracing specification, but <strong>their performance is not ideal</strong>. We discovered that TiKV's performance can be reduced by more than 50% when introducing these libraries.</p>
<p>TiKV's <strong>tracing implementation impacts performance by less than 5% by tracing and collecting spans efficiently, which only takes 20 ns</strong>.</p>
<p><img src="media/overhead-per-span.jpg" alt="Overhead per span"></p>
<div class="caption-center"> Overhead per span </div>
<p>Now let's see how it works.</p>
<h3 id="time-measurements">Time measurements</h3>
<p>Time is measured frequently in tracing. Each span needs two timestamps: the event's start and end time. Therefore, timing performance is critical.</p>
<p>Generally, to measure time for tracing, the measurement must ensure:</p>
<ul>
<li>The timestamp monotonically increases</li>
<li>High performance</li>
<li>High precision</li>
</ul>
<h4 id="stdinstant"><code>std::Instant</code></h4>
<p>Rust offers two structures in <code>std</code> to measure time:</p>
<ul>
<li>
<p><code>std::SystemTime::now()</code></p>
<p>It obtains the current system time. The downside is that the obtained timestamp is not monotonic, for example, when a user manually changes the clock, or there is a NTP service.</p>
</li>
<li>
<p><code>std::Instant::now()</code></p>
<p>It obtains monotonically increasing timestamps with nanosecond precision. Most Rust tracing libraries use it, but its performance is not ideal: it takes 50 ns to obtain timestamps twice. This is one of the reasons why most Rust tracing libraries do not trace efficiently.</p>
</li>
</ul>
<h4 id="coarse-time">Coarse time</h4>
<p>If you need efficient time measurement, coarse time is usually a good choice. Coarse time can be obtained by passing <code>CLOCK_MONOTONIC_COARSE</code> to the <code>clock_gettime</code> system call in Linux. The Rust community provides the <a href="https://docs.rs/coarsetime/0.1.18/coarsetime/"><code>coarsetime</code></a> crate to read coarse time easily:</p>
<div class="copyable-code-block ">
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">coarsetime::Instant::now()
</code></pre></div><p>Coarse time is so fast that it takes only 10 ns to obtain two timestamps. Its precision is low though, depending on Linux's configuration. The default precision is 4 ms.</p>
<p><strong>In most cases, coarse time can be the first choice</strong>, as:</p>
<ul>
<li>It's out of the box in the Linux system and easy to obtain.</li>
<li>For most applications, the 4 ms precision is acceptable.</li>
</ul>
<p>However, in TiKV's tracing scenarios, low-precision time measurement can lead to confusing results as shown below:</p>
<p><img src="media/high-precision-vs-low-precision-time-measurement.jpg" alt="High precision vs. low precision for time measurement"></p>
<div class="caption-center"> High precision vs. low precision for time measurement </div>
<p>To support tracing at microseconds or even nanoseconds precision while keeping performance, we use <strong>Time Stamp Counter (TSC)</strong>.</p>
<h4 id="tsc">TSC</h4>
<p>The TSC register has existed in modern x86 architecture CPUs since the Pentium processor introduced in 2003. It records the number of CPU clock cycles since reset. When the CPU clock rate is constant, it can be used for high-precision timing.</p>
<p><strong>The TSC meets the requirements of monotonic increase, high precision, and high performance at the same time.</strong> In our test environment, it only takes 15 ns to fetch TSC twice.</p>
<p>The TSC register cannot be used directly. When it's used as a time source, it has several problems that affect the accuracy, as listed below.</p>
<h5 id="tsc-increment-rate">TSC increment rate</h5>
<p>TSC increment rate is determined by the CPU frequency. <strong>Modern CPUs may dynamically adjust its frequency</strong>, for example, to save energy. As a result, <strong>the TSC increment rate is not constant</strong>:</p>
<p><img src="media/tsc-increment-rate.jpg" alt="TSC increment rate"></p>
<div class="caption-center"> TSC increment rate </div>
<p>In addition, <strong>some CPUs do not increase the TSC in sleep mode</strong>:</p>
<p><img src="media/tsc-does-not-increment-when-cpu-sleeps.jpg" alt="TSC doesn't increment when the CPU sleeps"></p>
<div class="caption-center"> TSC doesn't increment when the CPU sleeps </div>
<p>Some modern x86 architecture CPUs provide features to ensure the TSC increments at a constant rate. In Linux, you can use CPU flags in <code>/proc/cpuinfo</code> to check whether the TSC increment rate is constant:</p>
<ul>
<li><code>constant_tsc</code>: the TSC increments at the processor's nominal frequency instead of instantaneous frequency.</li>
<li><code>nonstop_tsc</code>: the TSC increments even when the CPU is in sleep state.</li>
</ul>
<h5 id="tsc-synchronization">TSC synchronization</h5>
<p>Even if TSC is constant, it cannot be used to measure time. In the x86 architecture, <strong>TSC registers are not guaranteed to be synchronized among all CPU cores</strong>. The following figure shows the measured TSC on a laptop produced in 2020 equipped with the latest x64 CPU at that time. As we can see, among the 16 cores, CPU 0's TSC value has an offset.</p>
<p><img src="media/tsc-values-for-16-cpu-cores.jpg" alt="TSC values for 16 CPU cores"></p>
<div class="caption-center"> TSC values for 16 CPU cores </div>
<p>Recall that in tracing, each span needs two timestamps, representing the start and end of the event. Due to the thread scheduling, the reads of the two timestamps may happen on different CPU cores. As a result, the delta of the two TSC values can produce incorrect elapsed time <strong>when the TSC is not synchronized between cores.</strong></p>
<p>For example:</p>
<ol>
<li>At t1, the thread is running on Core 1 and reads tsc1.</li>
<li>The operating system schedules the thread from Core 1 to Core 2.</li>
<li>At t2, the thread is running on Core 2 and reads tsc2.</li>
</ol>
<p><img src="media/tsc-value-calculation-for-multiple-cores.jpg" alt="TSC value calculation for multiple cores"></p>
<div class="caption-center"> An example of TSC value calculation for multiple cores </div>
<p>In the example above, the elapsed TSC (tsc2 - tsc1) is even negative!</p>
<p>To solve this problem, <strong>TiKV synchronizes the TSC value of each core by calculating TSC offsets:</strong></p>
<ol>
<li>TiKV arbitrarily takes two TSC values at two physical times on each core.</li>
<li>The physical time is used as the x-axis, and the TSC values are used as the y-axis. They can be used to form a line.</li>
<li>The TSC offset of each core is the gap of the line at y-axis, as shown in the following figure:</li>
</ol>
<p><img src="media/tsc-value-offset.jpg" alt="TSC value offset"></p>
<div class="caption-center"> TSC value offset </div>
<p>When the TSC offset is calculated, the <strong>process of obtaining the TSC values must not be on the same core</strong>. In Linux, you can use <code>sched_setaffinity</code> to set the thread's affinity to make the thread run on a certain core:</p>
<div class="copyable-code-block ">
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">fn set_affinity(cpuid: usize) -&gt; Result&lt;(), Error&gt; {

  use libc::{cpu_set_t, sched_setaffinity, CPU_SET};

  use std::mem::{size_of, zeroed};

  let mut set = unsafe { zeroed::&lt;cpu_set_t&gt;() };

  unsafe { CPU_SET(cpuid, &amp;mut set) };

  // Set the current thread&#39;s core affinity.

  if unsafe {

      sched_setaffinity(

          0, // Defaults to current thread

          size_of::&lt;cpu_set_t&gt;(),

          &amp;set as *const _,

      )

  } != 0

  {

      Err(std::io::Error::last_os_error().into())

  } else {

      Ok(())

  }

}
</code></pre></div><p>Now, we know the TSC offset of each CPU core. Next, we need to find out which CPU core we're working on. This can be known by <strong>using the RDTSCP command</strong>, which helps us atomically get the TSC value and CPU ID at the same time.</p>
<p>The Rust code is as follows:</p>
<div class="copyable-code-block ">
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">#[cfg(any(target_arch = &#34;x86&#34;, target_arch = &#34;x86_64&#34;))]

fn tsc_with_cpuid() -&gt; (u64, usize) {

  #[cfg(target_arch = &#34;x86&#34;)]

  use core::arch::x86::__rdtscp;

  #[cfg(target_arch = &#34;x86_64&#34;)]

  use core::arch::x86_64::__rdtscp;

  let mut aux = std::mem::MaybeUninit::&lt;u32&gt;::uninit();

  let tsc = unsafe { __rdtscp(aux.as_mut_ptr()) };

  let aux = unsafe { aux.assume_init() };

  // IA32_TSC_AUX are encoded by Linux kernel as follow format:

  //

  // 31       12 11      0

  // [ node id ][ cpu id ]

  (tsc, (aux &amp; 0xfff) as usize)

}
</code></pre></div><p>The high-precision and efficient time measurement solution described above has been extracted into a Rust library named <a href="https://github.com/zhongzc/minstant.git">minstant</a>, which can be reused for similar requirements.</p>
<h3 id="span-collection">Span collection</h3>
<p>Spans may be generated on each thread and finally be collected and aggregated into a trace. Therefore, we need a cross-thread span collection mechanism. <strong>Span collection is a common performance bottleneck of tracing libraries</strong>.</p>
<p>Common methods to perform thread-safe span collection are:</p>
<ul>
<li><code>Arc&lt;Mutex&lt;Vec&lt;Span&gt;&gt;&gt;</code></li>
<li><code>std::sync::mpsc::Receiver&lt;Span&gt;</code></li>
<li><code>crossbeam::channel::Receiver&lt;Span&gt;</code></li>
</ul>
<p>Among these methods, <code>crossbeam::channel</code> is the best choice. It takes about 40 ns to send and collect a span. This is not the end. To improve performance, TiKV uses a different method than the above three to collect spans:</p>
<ol>
<li>For the same thread, TiKV only collects spans on the local thread without any resource contention.</li>
<li>A batch of spans are collected and sent to the global collector.</li>
</ol>
<h4 id="local-span">Local span</h4>
<p>TiKV maintains a thread-local structure <code>LocalSpanLine</code> for each thread. It generates and stores <code>LocalSpan</code>. Another thread-local structure <code>LocalCollector</code> drives <code>LocalSpanLine</code> and collects <code>LocalSpan</code>. The following figure shows the relationship between these three.</p>
<p><img src="media/localspanline-in-tikv.jpg" alt="LocalSpanLine in TiKV"></p>
<div class="caption-center"> LocalSpanLine in TiKV </div>
<p>Because <code>LocalSpan</code>, <code>LocalSpanLine</code>, and <code>LocalCollector</code> are all thread-local, they don't introduce contentions and <strong>don't harm caches</strong>. As a result, the performance is extremely high: it only takes 4 ns to push a span into a local vector, as simple as a <code>Vec::push</code>.</p>
<p>In addition, when constructing the span hierarchy, thread-local variables can be used to implement the <strong>implicit context</strong> mechanism: <strong>users don't need to modify the function signature to pass the tracing context</strong>, which greatly reduces the intrusion of existing code.</p>
<p>Now, let's take a closer look at the implementation details of <code>LocalSpan</code> creation and collection.</p>
<p><code>LocalSpanLine</code> maintains a container, <code>SpanQueue</code>, to load the ongoing or completed <code>LocalSpan</code>s. &ldquo;Ongoing&rdquo; means that the start time of the event indicated by <code>LocalSpan</code> is known, but the end time is not. The <code>LocalSpan</code>s are stored in the <code>Vec</code> structure inside <code>SpanQueue</code>.</p>
<p>To construct the parent-child dependency between <code>LocalSpan</code>s implicitly, the context passing relies on the <code>next_parent_id</code> variable that is maintained by <code>SpanQueue</code>.</p>
<p>Next, we will use some examples to describe the process in detail.</p>
<p>Suppose we have a foo event. It occurs at 09:00 and lasts until 09:03:</p>
<div class="copyable-code-block ">
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">09:00  foo +

09:01      |

09:02      |

09:03      +
</code></pre></div><p><code>SpanQueue</code>'s initial state is empty, and <code>next_parent_id</code> is <code>root</code>. When foo occurs at 09:00, <code>SpanQueue</code> performs the following:</p>
<ol>
<li>Adds a new record and fills in the event name <code>foo</code>, start time <code>09:00</code>, and end time <code>empty</code>.</li>
<li>Assigns <code>next_parent_id</code>'s value to foo's parent.</li>
<li>Updates <code>next_parent_id</code> to <code>foo</code>.</li>
<li>Returns the index value <code>0</code> to receive the notification of the event end and backfill the end time.</li>
</ol>
<table>
  <tr>
   <td>Index
   </td>
   <td>Event
   </td>
   <td>Start time
   </td>
   <td>End time
   </td>
   <td>Parent
   </td>
   <td>next_parent_id
   </td>
  </tr>
  <tr>
   <td>0
   </td>
   <td>foo
   </td>
   <td>09:00
   </td>
   <td>N/A
   </td>
   <td>root
   </td>
   <td>foo
   </td>
  </tr>
</table>
<p>At the end of foo (at 09:03), the user submits the index and informs <code>SpanQueue</code> that the event is over. <code>SpanQueue</code> starts backfilling. It:</p>
<ol>
<li>Indexes to the record where the foo event is located by the submitted index.</li>
<li>Backfills the end time as <code>09:03</code>.</li>
<li>Updates <code>next_parent_id</code> to the record's parent.</li>
</ol>
<table>
  <tr>
   <td>Index
   </td>
   <td>Event
   </td>
   <td>Start time
   </td>
   <td>End time
   </td>
   <td>Parent
   </td>
   <td>next_parent_id
   </td>
  </tr>
  <tr>
   <td>0
   </td>
   <td>foo
   </td>
   <td>09:00
   </td>
   <td>09:03
   </td>
   <td>root
   </td>
   <td>root
   </td>
  </tr>
</table>
<p>The above example describes a single event's recording process. It's simple and effective. In fact, recording multiple events is only a repetition of the above process. For example, in the following process, the foo event contains two sub-events: bar and baz.</p>
<div class="copyable-code-block ">
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">09:00  foo +

09:01      | bar +

09:02      |     |

09:03      |     +

09:04      |

09:05      | baz +

09:06      |     |

09:07      |     +

09:08      +
</code></pre></div><p>As mentioned above, in addition to recording the start and end time of each event, <code>SpanQueue</code> also needs to record the parent-child dependency between each event. In the following example, when foo occurs, <code>SpanQueue</code>'s storage content is the same as above. When bar occurs, <code>SpanQueue</code> sets the bar's parent to <code>next_parent_id</code>'s current value (foo) and and updates <code>next_parent_id</code> to bar:</p>
<table>
  <tr>
   <td>Index
   </td>
   <td>Event
   </td>
   <td>Start time
   </td>
   <td>End time
   </td>
   <td>Parent
   </td>
   <td>next_parent_id
   </td>
  </tr>
  <tr>
   <td>0
   </td>
   <td>foo
   </td>
   <td>09:00
   </td>
   <td>N/A
   </td>
   <td>root
   </td>
   <td rowspan="2">bar
   </td>
  </tr>
  <tr>
   <td>1
   </td>
   <td>bar
   </td>
   <td>09:01
   </td>
   <td>N/A
   </td>
   <td>foo
   </td>
  </tr>
</table>
<p>When bar is over, it updates bar's end time and the <code>next_parent_id</code> variable based on the backfilling steps mentioned above:</p>
<table>
  <tr>
   <td>Index
   </td>
   <td>Event
   </td>
   <td>Start time
   </td>
   <td>End time
   </td>
   <td>Parent
   </td>
   <td>next_parent_id
   </td>
  </tr>
  <tr>
   <td>0
   </td>
   <td>foo
   </td>
   <td>09:00
   </td>
   <td>N/A
   </td>
   <td>root
   </td>
   <td rowspan="2">foo
   </td>
  </tr>
  <tr>
   <td>1
   </td>
   <td>bar
   </td>
   <td>09:01
   </td>
   <td>09:03
   </td>
   <td>foo
   </td>
  </tr>
</table>
<p>Finally, by repeating the above steps, <code>SpanQueue</code> records the information of these three events in an efficient way:</p>
<table>
  <tr>
   <td>Index
   </td>
   <td>Event
   </td>
   <td>Start time
   </td>
   <td>End time
   </td>
   <td>Parent
   </td>
   <td>next_parent_id
   </td>
  </tr>
  <tr>
   <td>0
   </td>
   <td>foo
   </td>
   <td>09:00
   </td>
   <td>09:08
   </td>
   <td>root
   </td>
   <td rowspan="3">root
   </td>
  </tr>
  <tr>
   <td>1
   </td>
   <td>bar
   </td>
   <td>09:01
   </td>
   <td>09:03
   </td>
   <td>foo
   </td>
  </tr>
  <tr>
   <td>2
   </td>
   <td>baz
   </td>
   <td>09:05
   </td>
   <td>09:07
   </td>
   <td>foo
   </td>
  </tr>
</table>
<p>We can connect these records in series to form the following trace tree structure:</p>
<p><img src="media/trace-tree-structure.jpg" alt="Trace tree structure"></p>
<div class="caption-center"> Trace tree structure </div>
<h4 id="normal-span">Normal span</h4>
<p>Although the recording of <code>LocalSpan</code> is efficient, it's not flexible enough due to its thread-local implementation. For example, in an asynchronous scenario, the creation and termination of some spans occur in different threads, so that the thread-local implementation doesn't work any longer.</p>
<p>For these problems, TiKV retains the thread-safe span recording method described at the beginning of the article: <code>crossbeam::channel</code> collects a single span at a time. This is called a <code>NormalSpan</code>.</p>
<p>From an implementation point of view, <code>NormalSpan</code> information is not recorded in the thread-local container, but is maintained by the corresponding variables to facilitate cross-thread movement. The parent-child relationship between <code>NormalSpan</code>s is no longer implicitly constructed by the thread local. You need to specify it manually.</p>
<p>However, <code>NormalSpan</code> and <code>LocalSpan</code> are not completely isolated. TiKV connects them through the following interactive methods. A set of <code>LocalSpan</code>s collected from <code>LocalCollector</code> <strong>can be mounted on <code>NormalSpan</code> as a subtree,</strong> as shown in the following figure. The number of mounts is unlimited. By allowing many-to-many mounting methods, TiKV supports tracing batch scenarios to a certain extent. Most tracing libraries in the community do not offer this.</p>
<p><img src="media/localspan-can-be-mounted-on-normalspan.jpg" alt="LocalSpans can be mounted on NormalSpan"></p>
<div class="caption-center"> LocalSpans can be mounted on NormalSpan </div>
<p>The above implementation forms <strong>the fast and slow paths of span collection.</strong> They work together to complete the recording of a request's execution path information:</p>
<ul>
<li><code>LocalSpan</code> cannot span threads but records efficiently. Collecting <code>LocalSpan</code>s in batches and then mounting them to ordinary spans means very low overhead.</li>
<li>The recording of ordinary span is slow, but it can be passed across threads and is more flexible to use.</li>
</ul>
<h2 id="how-to-use-the-high-performance-tracing-library">How to use the high-performance tracing library</h2>
<p>We extracted TiKV's high-performance tracing logic into an independent library <a href="https://github.com/tikv/minitrace-rust">minitrace-rust</a>. To use it, the general steps are:</p>
<ol>
<li>When the request arrives, create the corresponding root span.</li>
<li>When the request is on the execution path, record the event occurrence.</li>
<li>When the request is complete, collect all spans generated on the execution path.</li>
</ol>
<h3 id="create-and-collect-a-root-span">Create and collect a root span</h3>
<p>Usually, we can create a root span at the beginning of a request:</p>
<div class="copyable-code-block ">
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">for req in listener.incoming() {

  let (root_span, collector) = Span::root(&#34;http request&#34;);

  let guard = root_span.enter();

  my_request_handler(req);

}
</code></pre></div><p>By using the &ldquo;guard,&rdquo; the span can be ended automatically when the scope exits. In addition to returning the root span, <code>Span::root(event)</code> also returns a collector. The collector has a one-to-one correspondence with the root span. When the request is completed, we can call the collector's collect method to collect all spans generated on the execution path.</p>
<div class="copyable-code-block ">
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">let (root_span, collector) = Span::root(&#34;http request&#34;);

let guard = root_span.enter();

handle_http_request(req);

drop((guard, root_span));

let spans = collector.collect();
</code></pre></div><h3 id="event-record">Event record</h3>
<p>We recommend that you use the trace and the <code>trace_async</code> macro provided by minitrace-rust for function-level event recording. This method records the following execution information for a single function:</p>
<ul>
<li>The call occurring time</li>
<li>The call return time</li>
<li>The direct or indirect caller's reference</li>
<li>The reference of the sub-function called directly or indirectly</li>
</ul>
<p>The following example traces two synchronous functions, foo and bar, by adding <code>trace(event)</code> as the attribute of these two functions. We can record the function's execution information:</p>
<div class="copyable-code-block ">
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">#[trace(&#34;foo&#34;)]

fn foo() -&gt; u32 {

  bar();

  42

}

#[trace(&#34;bar&#34;)]

fn bar() { }
</code></pre></div><p>The final recorded information includes the two functions&rsquo; start and end times and the function call relationship: foo calls bar.</p>
<p><img src="media/foo-calls-bar.jpg" alt="foo calls bar"></p>
<div class="caption-center"> foo calls bar </div>
<p>To record asynchronous functions, the steps are slightly different:</p>
<ol>
<li>
<p>Replace trace with <code>trace_async</code> as follows:</p>
<div class="copyable-code-block ">
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">#[trace_async(&#34;foo async&#34;)]

async fn foo_aysnc() -&gt; u32 {

  bar_async().await;

  42

}

#[trace_async(&#34;bar async&#34;)]

async fn bar_async() {

  yield_now().await;

}
</code></pre></div></li>
<li>
<p>Bind the future to a span. Wrap the task with the future adapter <code>in_span</code> provided by minitrace-rust.</p>
<p>In the Rust asynchronous context, a task refers to the future spawned to an executor, also known as the root future. For example, the following <code>foo_async</code> is a task:</p>
<div class="copyable-code-block ">
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">executor::spawn(

  foo_async()

);
</code></pre></div><p>Suppose you want to trace a task like <code>foo_async</code> and bind it to a span created by <code>Span::from_local_parent(event)</code>. The application code is as follows:</p>
<div class="copyable-code-block ">
</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">executor::spawn(

  foo_async().in_span(Span::from_local_parent(&#34;Task: foo_async&#34;))

);
</code></pre></div></li>
</ol>
<p>The following figure shows the result of the trace:</p>
<p><img src="media/trace-foo-async-task.jpg" alt="Trace the foo_async task"></p>
<div class="caption-center"> Trace the foo_async task </div>
<h2 id="conclusion">Conclusion</h2>
<p>TiKV is a distributed key-value database. Adding an observation feature to TiKV can be difficult, because it has higher performance requirements than an ordinary application. In addition to tracing, TiKV and its upper SQL database TiDB also have other challenging observational requirements. <a href="https://pingcap.com/">PingCAP</a>&lsquo;s Insight team focuses on solving such observation problems and implementing features. If you're interested, join the Slack channel <a href="https://slack.tidb.io/invite?team=tidb-community&amp;channel=sig-diagnosis&amp;ref=tracing">#sig-diagnosis</a> for discussions!</p>
</div>
                </div>
                <div class="article-toc"></div><div class="ssba-wrap">
    <div class="ssba">
        <a data-site="" class="ssba_twitter_share" href="http://twitter.com/share?url=https%3a%2f%2fidiks.com%2fblog%2fhow-we-trace-a-kv-database-with-less-than-5-percent-performance-impact%2f" target="_blank">
        
            <img src="/images/svgs/twitter-icon.svg" alt="Twitter icon" />
        </a>
        <a data-site="reddit" class="ssba_reddit_share" href="http://reddit.com/submit?url=https%3a%2f%2fidiks.com%2fblog%2fhow-we-trace-a-kv-database-with-less-than-5-percent-performance-impact%2f&title=How%20We%20Trace%20a%20KV%20Database%20with%20Less%20than%205%25%20Performance%20Impact" target="_blank">
        
            <img src="/images/svgs/reddit-icon.svg" alt="Reddit icon" />
        </a>
        <a data-site="" class="ssba_facebook_share" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fidiks.com%2fblog%2fhow-we-trace-a-kv-database-with-less-than-5-percent-performance-impact%2f" target="_blank">
        
            <img src="/images/svgs/facebook-icon.svg" alt="Fackbook icon" />
        </a>
        <a data-site="linkedin" class="ssba_linkedin_share" href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fidiks.com%2fblog%2fhow-we-trace-a-kv-database-with-less-than-5-percent-performance-impact%2f" target="_blank">
        
            <img src="/images/svgs/linkedin-icon.svg" alt="Linkedin icon" />
        </a>
        <a data-site="hackernews" class="ssba_hackernews_share" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fidiks.com%2fblog%2fhow-we-trace-a-kv-database-with-less-than-5-percent-performance-impact%2f&t=How%20We%20Trace%20a%20KV%20Database%20with%20Less%20than%205%25%20Performance%20Impact" target="_blank">
        
            <img src="/images/svgs/hacker-news-icon.svg" alt="Hacker News icon" />
        </a>
    </div>
</div>
<div class="trackable-btns">
                    <a href="/download" onclick="trackViews('How We Trace a KV Database with Less than 5% Performance Impact', 'download-tidb-btn-bottom')"><button>Download
                        TiDB</button></a>
                    <a href="https://share.hsforms.com/1e2W03wLJQQKPd1d9rCbj_Q2npzm"
                      onclick="trackViews('How We Trace a KV Database with Less than 5% Performance Impact', 'subscribe-blog-btn-bottom')"><button>Subscribe to
                        Blog</button></a>
                </div>
            </div>
            <div class="sidebar-page">
                <div class="sticky-sidebar">
                    <p class="toc-title">What’s on this page</p>
                    <div id="smart_toc_wrapper"></div>
                </div>
            </div>
        </div>
    </div>
<footer>
    <div class="container">
        <div class="flex-list-wrap">
            <div class="flex-list">
                <h4 class="list-title"><strong>Product</strong></h4>
                <ul>
                <li><a href="/docs/v3.0/">TiDB</a></li>
                <li><a href="/docs/v3.0/reference/tispark/">TiSpark</a></li>
                <li><a href="/docs/v3.0/roadmap/">Roadmap</a></li>
                </ul>
            </div>
            <div class="flex-list">
                <h4 class="list-title"><strong>Docs</strong></h4>
                <ul>
                <li><a href="/docs/stable/quick-start-with-tidb/">Quick Start</a></li>
                <li><a href="/blog/2017-07-24-tidbbestpractice/">Best Practices</a></li>
                <li><a href="/docs/stable/faq/tidb/">FAQ</a></li>
                <li><a href="/docs/stable/reference/tools/user-guide/">TiDB Tools</a></li>
                <li><a href="/docs/dev/releases/rn/">Release Notes</a></li>
                </ul>
            </div>
            <div class="flex-list">
                <h4 class="list-title"><strong>Resources</strong></h4>
                <ul>
                <li><a href="/blog/">Blog</a></li>
                <li><a href="/weekly/">Monthly</a></li>
                <li><a href="https://github.com/idiks" target="_blank">GitHub</a></li>
                <li><a href="/community">TiDB Community</a></li>
                </ul>
            </div>
            <div class="flex-list">
                <h4 class="list-title"><strong>Company</strong></h4>
                <ul>
                <li><a href="/about/">About</a></li>
                <li><a href="/jobs" target="_blank">Careers</a></li>
                <li><a href="/news/">News</a></li>
                <li><a href="/contact-us/">Contact Us</a></li>
                <li><a href="/privacy-policy/">Privacy Policy</a></li>
                <li><a href="/terms-of-service/">Terms of Service</a></li>
                </ul>
            </div>
        </div>
        <div class="contact-list-wrap">
            <div class="flex-list">
                <h4 class="list-title"><strong>Connect</strong></h4>
                <ul>
                <li><a href="https://twitter.com/idiks" class="twitter" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" width="18" height="19"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"/></svg> Twitter</a></li>
                <li><a href="https://www.linkedin.com/company/idiks/" class="linkedin" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="16" viewBox="0 0 438.536 438.535"><path d="M5.424 145.895H99.64v282.932H5.424zM408.842 171.739c-19.791-21.604-45.967-32.408-78.512-32.408-11.991 0-22.891 1.475-32.695 4.427-9.801 2.95-18.079 7.089-24.838 12.419-6.755 5.33-12.135 10.278-16.129 14.844-3.798 4.337-7.512 9.389-11.136 15.104v-40.232h-93.935l.288 13.706c.193 9.139.288 37.307.288 84.508 0 47.205-.19 108.777-.572 184.722h93.931V270.942c0-9.705 1.041-17.412 3.139-23.127 4-9.712 10.037-17.843 18.131-24.407 8.093-6.572 18.13-9.855 30.125-9.855 16.364 0 28.407 5.662 36.117 16.987 7.707 11.324 11.561 26.98 11.561 46.966V428.82h93.931V266.664c-.007-41.688-9.897-73.328-29.694-94.925zM53.103 9.708c-15.796 0-28.595 4.619-38.4 13.848C4.899 32.787 0 44.441 0 58.529 0 72.42 4.758 84.034 14.275 93.358c9.514 9.325 22.078 13.99 37.685 13.99h.571c15.99 0 28.887-4.661 38.688-13.99 9.801-9.324 14.606-20.934 14.417-34.829-.19-14.087-5.047-25.742-14.561-34.973C81.562 14.323 68.9 9.708 53.103 9.708z"/></svg> LinkedIn</a></li>
                <li><a href="https://www.reddit.com/r/idiks/" class="reddit" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 279.748 279.748" width="18" height="18"><path d="M279.748 133.142c0-19.299-15.701-35-35-35-10.768 0-20.674 4.812-27.279 13.064-18.532-8.431-39.663-13.626-62.015-15.271l19.206-60.692 42.895 9.294c3.285 12.782 14.901 22.258 28.693 22.258 16.336 0 29.627-13.29 29.627-29.626 0-16.336-13.291-29.627-29.627-29.627-11.801 0-21.999 6.941-26.759 16.95l-49.497-10.725a10.002 10.002 0 0 0-11.651 6.756L134.636 95.43c-26.164.638-50.988 6.053-72.356 15.775-6.606-8.251-16.512-13.063-27.28-13.063-19.299 0-35 15.701-35 35 0 9.373 3.683 18.173 10.222 24.709-3.9 8.37-5.875 17.076-5.875 25.936 0 24.048 14.396 46.492 40.538 63.199 25.447 16.264 59.183 25.221 94.989 25.221 35.808 0 69.542-8.957 94.989-25.221 26.142-16.707 40.538-39.151 40.538-63.199 0-8.859-1.975-17.565-5.875-25.936 6.539-6.537 10.222-15.336 10.222-24.709zM15.369 145.139c-2.212-3.59-3.369-7.688-3.369-11.997 0-12.682 10.317-23 23-23 5.444 0 10.558 1.851 14.649 5.258-14.622 8.302-26.132 18.289-34.28 29.739zm52.671 20.266c0-13.785 11.215-25 25-25s25 11.215 25 25-11.215 25-25 25-25-11.215-25-25zm123.119 57.054c-9.745 10.637-29.396 17.244-51.285 17.244-21.888 0-41.539-6.607-51.284-17.244a9.937 9.937 0 0 1-2.617-7.192 9.933 9.933 0 0 1 3.235-6.937 9.974 9.974 0 0 1 6.754-2.627c2.797 0 5.484 1.183 7.373 3.244 5.803 6.333 20.827 10.756 36.539 10.756s30.737-4.423 36.539-10.756a10.022 10.022 0 0 1 7.374-3.244c2.508 0 4.906.933 6.755 2.627a9.928 9.928 0 0 1 3.234 6.937 9.933 9.933 0 0 1-2.617 7.192zm-4.451-32.054c-13.785 0-25-11.215-25-25s11.215-25 25-25 25 11.215 25 25-11.215 25-25 25zm77.671-45.266c-8.147-11.45-19.657-21.436-34.28-29.739 4.092-3.408 9.205-5.258 14.649-5.258 12.683 0 23 10.318 23 23 0 4.309-1.157 8.407-3.369 11.997z"/></svg>Reddit</a></li>
                <li><a href="https://groups.google.com/forum/#!forum/idiks-user" class="google-plus" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 491.858 491.858" width="18" height="20"><path d="M377.472 224.957H201.319v58.718H308.79c-16.032 51.048-63.714 88.077-120.055 88.077-69.492 0-125.823-56.335-125.823-125.824 0-69.492 56.333-125.823 125.823-125.823 34.994 0 66.645 14.289 89.452 37.346l42.622-46.328c-34.04-33.355-80.65-53.929-132.074-53.929C84.5 57.193 0 141.693 0 245.928s84.5 188.737 188.736 188.737c91.307 0 171.248-64.844 188.737-150.989v-58.718l-.001-.001zM491.858 224.857h-36.031v-36.031h-30.886v36.031H388.91v30.883h36.031v36.032h30.886V255.74h36.031z"/></svg>Google Group</a></li>
                <li><a href="https://stackoverflow.com/questions/tagged/idiks" class="stack-overflow" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="17" viewBox="0 0 547.597 547.597"><path d="M140.81 475.111h.024l189.91-.269c8.434-.013 15.3-6.886 15.3-15.318v-21.298c0-8.428-6.854-15.288-15.3-15.288l-189.91.264c-8.433.012-15.3 6.885-15.3 15.318v21.31c.001 8.427 6.855 15.281 15.276 15.281z"/><path d="M58.667 517.854c.073 29.26.073 29.449 3.072 29.449h.055l10.612.294h.086s85.814 0 171.629-.036c42.914-.019 85.821-.05 118-.092 16.09-.019 29.505-.043 38.887-.074 17.803-.055 17.803-.055 17.803-3.072l.3-10.697V333.299c0-8.434-6.866-15.3-15.3-15.3h-11.909c-8.434 0-15.3 6.866-15.3 15.3V496.22c0 5.062-4.119 9.18-9.181 9.18H110.51c-5.061 0-9.18-4.118-9.18-9.18V333.299c0-8.434-6.867-15.3-15.3-15.3H73.82c-8.433 0-15.3 6.86-15.3 15.3 0 23.342.012 76.084.055 122.981.019 23.447.05 45.442.092 61.574z"/><path d="M142.322 397.399l189.402 17.467c.478.043.948.062 1.413.062 7.956 0 14.468-5.985 15.159-13.917l1.83-21.096c.729-8.396-5.508-15.851-13.898-16.628l-189.102-17.461c-8.593-.795-15.869 5.441-16.653 13.825l-1.97 21.108a15.172 15.172 0 0 0 3.452 11.181 15.19 15.19 0 0 0 10.367 5.459zM437.636 208.849a15.253 15.253 0 0 0 17.694 12.443l21.065-3.678c8.311-1.451 13.898-9.395 12.454-17.706l-32.504-187.23c-1.42-8.207-9.21-13.917-17.692-12.448l-21.065 3.678c-8.311 1.451-13.898 9.395-12.454 17.705l32.502 187.236zM190.333 194.375l163.6 96.708a15.28 15.28 0 0 0 7.778 2.136c5.393 0 10.447-2.876 13.183-7.509l10.876-18.36c2.08-3.519 2.674-7.631 1.658-11.591a15.18 15.18 0 0 0-7.032-9.358l-163.6-96.714c-7.014-4.149-16.836-1.597-20.967 5.374l-10.869 18.36a15.2 15.2 0 0 0-1.658 11.591 15.21 15.21 0 0 0 7.031 9.363zM387.525 240.501a15.276 15.276 0 0 0 12.626 6.659c3.091 0 6.077-.924 8.635-2.681l17.405-11.934c6.953-4.768 8.752-14.314 4.015-21.292L323.29 54.104c-4.584-6.732-14.498-8.623-21.236-3.984l-17.737 12.21c-6.945 4.779-8.727 14.327-3.971 21.291l107.179 156.88zM154.482 302.319l183.465 49.156c1.298.349 2.632.526 3.966.526 6.903 0 12.98-4.67 14.762-11.347l5.508-20.624c2.179-8.152-2.681-16.555-10.826-18.74l-183.465-49.162c-8.017-2.148-16.604 2.852-18.728 10.826l-5.508 20.63c-2.179 8.142 2.68 16.551 10.826 18.735z"/></svg>Stack Overflow</a></li>
                </ul>
            </div>
            <div class="subscribe">
                <a href="https://share.hsforms.com/1e2W03wLJQQKPd1d9rCbj_Q2npzm"><button class="btn btn-subscribe f-tc">Subscribe to Blog</button></a>
            </div>
        </div>
    </div>
    <div class="container copyright-container">
        <p class="copyright">&copy; 2025 iDIKS. All Rights Reserved.</p>
        <a href="/blog-cn" class="copyright-btn-lang" id="lang">中文</a>
    </div>
</footer>
<button class="back-to-top" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 284.929 284.929"><path d="M282.082 195.285L149.028 62.24c-1.901-1.903-4.088-2.856-6.562-2.856s-4.665.953-6.567 2.856L2.856 195.285C.95 197.191 0 199.378 0 201.853c0 2.474.953 4.664 2.856 6.566l14.272 14.271c1.903 1.903 4.093 2.854 6.567 2.854s4.664-.951 6.567-2.854l112.204-112.202 112.208 112.209c1.902 1.903 4.093 2.848 6.563 2.848 2.478 0 4.668-.951 6.57-2.848l14.274-14.277c1.902-1.902 2.847-4.093 2.847-6.566.001-2.476-.944-4.666-2.846-6.569z" fill="#FFF"/></svg>
</button>
</div><div class="overlay"></div><script src="https://static.idiks.com/js/jquery.min.js"></script><script type="text/javascript" src="/js/vendor/lazyload.min.js"></script>
    <script type="text/javascript" src="/js/doc.js"></script>
    <script type="text/javascript" src="/js/anchor.js"></script><script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><script src="https://browser.sentry-cdn.com/5.11.0/bundle.min.js" integrity="sha384-jbFinqIbKkHNg+QL+yxB4VrBC0EAPTuaLGeRT0T+NfEV89YC6u1bKxHLwoo+/xxY" crossorigin="anonymous"></script><script>Sentry.init({ 
            dsn: 'https://3f28ed393c5545daa74496b3cdb2e9ba@sentry.io/1887163' 
        });</script><script src="/js/app.js"></script></body></html>